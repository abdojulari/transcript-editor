#!/usr/bin/env ruby
# Installation script for Amplify.

require 'etc'
require 'yaml'
require 'highline'
require 'securerandom'

def modify_yaml_file(root_path_to_file, changes = {})
  yml_file_path = File.join(File.dirname(__FILE__), '..', root_path_to_file)
  yaml_content = YAML.load_file(yml_file_path)
  yaml_content = yaml_content.merge(changes)
  File.open(yml_file_path, 'w') { |f| f.write(yaml_content.to_yaml) }
end

cli = HighLine.new

env_name = cli.ask("Current environment? ") { |q| q.default = "development" }

db_cfg_input = {}
db_cfg_input[env_name] = {}

db_cfg_input[env_name]['adapter'] = cli.ask("Database adapter? ") { |q| q.default = 'postgresql' }
db_cfg_input[env_name]['database'] = cli.ask("Name of database? ") { |q| q.default = "nsw-state-library-amplify_#{env_name}" }
db_cfg_input[env_name]['host'] = cli.ask("Database hostname? ") { |q| q.default = 'localhost' }
db_cfg_input[env_name]['username'] = cli.ask("Username to access database? ") { |q| q.default = Etc.getlogin }
db_cfg_input[env_name]['password'] = cli.ask("Password to access database? ") { |q| q.default = '' }

app_cfg_input = {}
app_cfg_input[env_name] = {}

app_cfg_input[env_name]['PROJECT_ID'] = cli.ask("Default project ID? ") { |q| q.default = "nsw-state-library-amplify" }

app_cfg_input[env_name]['SECRET_KEY_BASE'] = SecureRandom.hex(64)
# app_cfg_input[env_name]['PUA_CLIENT_ID'] = cli.ask("Pop-Up Archive client ID? ") { |q| q.default = "xxx" }
# app_cfg_input[env_name]['PUA_CLIENT_SECRET'] = cli.ask("Pop-Up Archive client secret? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['VOICEBASE_API_KEY'] = cli.ask("Voicebase API key? ") { |q| q.default = "xxx" }
# app_cfg_input[env_name]['VOICEBASE_CLIENT_ID'] = cli.ask("Voicebase client ID? ") { |q| q.default = "xxx" }
# app_cfg_input[env_name]['VOICEBASE_CLIENT_SECRET'] = cli.ask("Voicebase client secret? ") { |q| q.default = "xxx" }

app_cfg_input[env_name]['AWS_S3_ACCESS_KEY_ID'] = cli.ask("AWS S3 client ID? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['AWS_S3_SECRET_ACCESS_KEY'] = cli.ask("AWS S3 client secret? ") { |q| q.default = "xxx" }

app_cfg_input[env_name]['GOOGLE_CLIENT_ID'] = cli.ask("Google client ID? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['GOOGLE_CLIENT_SECRET'] = cli.ask("Google client secret? ") { |q| q.default = "xxx" }

app_cfg_input[env_name]['FACEBOOK_APP_ID'] = cli.ask("Facebook client ID? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['FACEBOOK_APP_SECRET'] = cli.ask("Facebook client secret? ") { |q| q.default = "xxx" }

app_cfg_input[env_name]['SENDER_EMAIL'] = cli.ask("Email account to send from? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['SMTP_URI'] = cli.ask("SMTP server URI? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['SMTP_PORT'] = cli.ask("SMTP server port? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['SES_SMTP_USERNAME'] = cli.ask("SMTP server username? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['SES_SMTP_PASSWORD'] = cli.ask("SMTP server password? ") { |q| q.default = "xxx" }
app_cfg_input[env_name]['DEFAULT_MAILER_HOST'] = cli.ask("Default mailer hostname? ") { |q| q.default = "xxx" }

app_cfg_input[env_name]['REDIS_URL'] = cli.ask("Redis server URL? ") { |q| q.default = "redis://localhost:6379" }

app_cfg_input[env_name]['NEW_RELIC_LICENSE_KEY'] = cli.ask("New Relic license key? ") { |q| q.default = "nsw-state-library-amplify" }

modify_yaml_file(File.join('config', 'database.yml'), db_cfg_input)
modify_yaml_file(File.join('config', 'application.yml'), app_cfg_input)
