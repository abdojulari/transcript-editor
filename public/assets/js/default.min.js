function naturalSort(t,e){var i,n,r=/(^([+\-]?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?(?=\D|\s|$))|^0x[\da-fA-F]+$|\d+)/g,s=/^\s+|\s+$/g,a=/\s+/g,o=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,c=/^0x[0-9a-f]+$/i,l=/^0/,u=function(t){return(naturalSort.insensitive&&(""+t).toLowerCase()||""+t).replace(s,"")},h=u(t),d=u(e),p=h.replace(r,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),f=d.replace(r,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),v=parseInt(h.match(c),16)||1!==p.length&&Date.parse(h),g=parseInt(d.match(c),16)||v&&d.match(o)&&Date.parse(d)||null,m=function(t,e){return(!t.match(l)||1==e)&&parseFloat(t)||t.replace(a," ").replace(s,"")||0};if(g){if(v<g)return-1;if(v>g)return 1}for(var y=0,_=p.length,b=f.length,w=Math.max(_,b);y<w;y++){if(i=m(p[y]||"",_),n=m(f[y]||"",b),isNaN(i)!==isNaN(n))return isNaN(i)?1:-1;if(/[^\x00-\x80]/.test(i+n)&&i.localeCompare){var k=i.localeCompare(n);return k/Math.abs(k)}if(i<n)return-1;if(i>n)return 1}}(function(){function t(t){function e(e,i,n,r,s,a){for(;s>=0&&a>s;s+=t){var o=r?r[s]:s;n=i(n,e[o],o,e)}return n}return function(i,n,r,s){n=_(n,s,4);var a=!P(i)&&y.keys(i),o=(a||i).length,c=t>0?0:o-1;return arguments.length<3&&(r=i[a?a[c]:c],c+=t),e(i,n,r,a,c,o)}}function e(t){return function(e,i,n){i=b(i,n);for(var r=T(e),s=t>0?0:r-1;s>=0&&r>s;s+=t)if(i(e[s],s,e))return s;return-1}}function i(t,e,i){return function(n,r,s){var a=0,o=T(n);if("number"==typeof s)t>0?a=s>=0?s:Math.max(s+o,a):o=s>=0?Math.min(s+1,o):s+o+1;else if(i&&s&&o)return s=i(n,r),n[s]===r?s:-1;if(r!==r)return s=e(u.call(n,a,o),y.isNaN),s>=0?s+a:-1;for(s=t>0?a:o-1;s>=0&&o>s;s+=t)if(n[s]===r)return s;return-1}}function n(t,e){var i=L.length,n=t.constructor,r=y.isFunction(n)&&n.prototype||o,s="constructor";for(y.has(t,s)&&!y.contains(e,s)&&e.push(s);i--;)s=L[i],s in t&&t[s]!==r[s]&&!y.contains(e,s)&&e.push(s)}var r=this,s=r._,a=Array.prototype,o=Object.prototype,c=Function.prototype,l=a.push,u=a.slice,h=o.toString,d=o.hasOwnProperty,p=Array.isArray,f=Object.keys,v=c.bind,g=Object.create,m=function(){},y=function(t){return t instanceof y?t:this instanceof y?void(this._wrapped=t):new y(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=y),exports._=y):r._=y,y.VERSION="1.8.3";var _=function(t,e,i){if(void 0===e)return t;switch(null==i?3:i){case 1:return function(i){return t.call(e,i)};case 2:return function(i,n){return t.call(e,i,n)};case 3:return function(i,n,r){return t.call(e,i,n,r)};case 4:return function(i,n,r,s){return t.call(e,i,n,r,s)}}return function(){return t.apply(e,arguments)}},b=function(t,e,i){return null==t?y.identity:y.isFunction(t)?_(t,e,i):y.isObject(t)?y.matcher(t):y.property(t)};y.iteratee=function(t,e){return b(t,e,1/0)};var w=function(t,e){return function(i){var n=arguments.length;if(2>n||null==i)return i;for(var r=1;n>r;r++)for(var s=arguments[r],a=t(s),o=a.length,c=0;o>c;c++){var l=a[c];e&&void 0!==i[l]||(i[l]=s[l])}return i}},k=function(t){if(!y.isObject(t))return{};if(g)return g(t);m.prototype=t;var e=new m;return m.prototype=null,e},S=function(t){return function(e){return null==e?void 0:e[t]}},x=Math.pow(2,53)-1,T=S("length"),P=function(t){var e=T(t);return"number"==typeof e&&e>=0&&x>=e};y.each=y.forEach=function(t,e,i){e=_(e,i);var n,r;if(P(t))for(n=0,r=t.length;r>n;n++)e(t[n],n,t);else{var s=y.keys(t);for(n=0,r=s.length;r>n;n++)e(t[s[n]],s[n],t)}return t},y.map=y.collect=function(t,e,i){e=b(e,i);for(var n=!P(t)&&y.keys(t),r=(n||t).length,s=Array(r),a=0;r>a;a++){var o=n?n[a]:a;s[a]=e(t[o],o,t)}return s},y.reduce=y.foldl=y.inject=t(1),y.reduceRight=y.foldr=t(-1),y.find=y.detect=function(t,e,i){var n;return n=P(t)?y.findIndex(t,e,i):y.findKey(t,e,i),void 0!==n&&n!==-1?t[n]:void 0},y.filter=y.select=function(t,e,i){var n=[];return e=b(e,i),y.each(t,function(t,i,r){e(t,i,r)&&n.push(t)}),n},y.reject=function(t,e,i){return y.filter(t,y.negate(b(e)),i)},y.every=y.all=function(t,e,i){e=b(e,i);for(var n=!P(t)&&y.keys(t),r=(n||t).length,s=0;r>s;s++){var a=n?n[s]:s;if(!e(t[a],a,t))return!1}return!0},y.some=y.any=function(t,e,i){e=b(e,i);for(var n=!P(t)&&y.keys(t),r=(n||t).length,s=0;r>s;s++){var a=n?n[s]:s;if(e(t[a],a,t))return!0}return!1},y.contains=y.includes=y.include=function(t,e,i,n){return P(t)||(t=y.values(t)),("number"!=typeof i||n)&&(i=0),y.indexOf(t,e,i)>=0},y.invoke=function(t,e){var i=u.call(arguments,2),n=y.isFunction(e);return y.map(t,function(t){var r=n?e:t[e];return null==r?r:r.apply(t,i)})},y.pluck=function(t,e){return y.map(t,y.property(e))},y.where=function(t,e){return y.filter(t,y.matcher(e))},y.findWhere=function(t,e){return y.find(t,y.matcher(e))},y.max=function(t,e,i){var n,r,s=-1/0,a=-1/0;if(null==e&&null!=t){t=P(t)?t:y.values(t);for(var o=0,c=t.length;c>o;o++)n=t[o],n>s&&(s=n)}else e=b(e,i),y.each(t,function(t,i,n){r=e(t,i,n),(r>a||r===-1/0&&s===-1/0)&&(s=t,a=r)});return s},y.min=function(t,e,i){var n,r,s=1/0,a=1/0;if(null==e&&null!=t){t=P(t)?t:y.values(t);for(var o=0,c=t.length;c>o;o++)n=t[o],s>n&&(s=n)}else e=b(e,i),y.each(t,function(t,i,n){r=e(t,i,n),(a>r||1/0===r&&1/0===s)&&(s=t,a=r)});return s},y.shuffle=function(t){for(var e,i=P(t)?t:y.values(t),n=i.length,r=Array(n),s=0;n>s;s++)e=y.random(0,s),e!==s&&(r[s]=r[e]),r[e]=i[s];return r},y.sample=function(t,e,i){return null==e||i?(P(t)||(t=y.values(t)),t[y.random(t.length-1)]):y.shuffle(t).slice(0,Math.max(0,e))},y.sortBy=function(t,e,i){return e=b(e,i),y.pluck(y.map(t,function(t,i,n){return{value:t,index:i,criteria:e(t,i,n)}}).sort(function(t,e){var i=t.criteria,n=e.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return t.index-e.index}),"value")};var C=function(t){return function(e,i,n){var r={};return i=b(i,n),y.each(e,function(n,s){var a=i(n,s,e);t(r,n,a)}),r}};y.groupBy=C(function(t,e,i){y.has(t,i)?t[i].push(e):t[i]=[e]}),y.indexBy=C(function(t,e,i){t[i]=e}),y.countBy=C(function(t,e,i){y.has(t,i)?t[i]++:t[i]=1}),y.toArray=function(t){return t?y.isArray(t)?u.call(t):P(t)?y.map(t,y.identity):y.values(t):[]},y.size=function(t){return null==t?0:P(t)?t.length:y.keys(t).length},y.partition=function(t,e,i){e=b(e,i);var n=[],r=[];return y.each(t,function(t,i,s){(e(t,i,s)?n:r).push(t)}),[n,r]},y.first=y.head=y.take=function(t,e,i){return null==t?void 0:null==e||i?t[0]:y.initial(t,t.length-e)},y.initial=function(t,e,i){return u.call(t,0,Math.max(0,t.length-(null==e||i?1:e)))},y.last=function(t,e,i){return null==t?void 0:null==e||i?t[t.length-1]:y.rest(t,Math.max(0,t.length-e))},y.rest=y.tail=y.drop=function(t,e,i){return u.call(t,null==e||i?1:e)},y.compact=function(t){return y.filter(t,y.identity)};var $=function(t,e,i,n){for(var r=[],s=0,a=n||0,o=T(t);o>a;a++){var c=t[a];if(P(c)&&(y.isArray(c)||y.isArguments(c))){e||(c=$(c,e,i));var l=0,u=c.length;for(r.length+=u;u>l;)r[s++]=c[l++]}else i||(r[s++]=c)}return r};y.flatten=function(t,e){return $(t,e,!1)},y.without=function(t){return y.difference(t,u.call(arguments,1))},y.uniq=y.unique=function(t,e,i,n){y.isBoolean(e)||(n=i,i=e,e=!1),null!=i&&(i=b(i,n));for(var r=[],s=[],a=0,o=T(t);o>a;a++){var c=t[a],l=i?i(c,a,t):c;e?(a&&s===l||r.push(c),s=l):i?y.contains(s,l)||(s.push(l),r.push(c)):y.contains(r,c)||r.push(c)}return r},y.union=function(){return y.uniq($(arguments,!0,!0))},y.intersection=function(t){for(var e=[],i=arguments.length,n=0,r=T(t);r>n;n++){var s=t[n];if(!y.contains(e,s)){for(var a=1;i>a&&y.contains(arguments[a],s);a++);a===i&&e.push(s)}}return e},y.difference=function(t){var e=$(arguments,!0,!0,1);return y.filter(t,function(t){return!y.contains(e,t)})},y.zip=function(){return y.unzip(arguments)},y.unzip=function(t){for(var e=t&&y.max(t,T).length||0,i=Array(e),n=0;e>n;n++)i[n]=y.pluck(t,n);return i},y.object=function(t,e){for(var i={},n=0,r=T(t);r>n;n++)e?i[t[n]]=e[n]:i[t[n][0]]=t[n][1];return i},y.findIndex=e(1),y.findLastIndex=e(-1),y.sortedIndex=function(t,e,i,n){i=b(i,n,1);for(var r=i(e),s=0,a=T(t);a>s;){var o=Math.floor((s+a)/2);i(t[o])<r?s=o+1:a=o}return s},y.indexOf=i(1,y.findIndex,y.sortedIndex),y.lastIndexOf=i(-1,y.findLastIndex),y.range=function(t,e,i){null==e&&(e=t||0,t=0),i=i||1;for(var n=Math.max(Math.ceil((e-t)/i),0),r=Array(n),s=0;n>s;s++,t+=i)r[s]=t;return r};var A=function(t,e,i,n,r){if(!(n instanceof e))return t.apply(i,r);var s=k(t.prototype),a=t.apply(s,r);return y.isObject(a)?a:s};y.bind=function(t,e){if(v&&t.bind===v)return v.apply(t,u.call(arguments,1));if(!y.isFunction(t))throw new TypeError("Bind must be called on a function");var i=u.call(arguments,2),n=function(){return A(t,n,e,this,i.concat(u.call(arguments)))};return n},y.partial=function(t){var e=u.call(arguments,1),i=function(){for(var n=0,r=e.length,s=Array(r),a=0;r>a;a++)s[a]=e[a]===y?arguments[n++]:e[a];for(;n<arguments.length;)s.push(arguments[n++]);return A(t,i,this,this,s)};return i},y.bindAll=function(t){var e,i,n=arguments.length;if(1>=n)throw new Error("bindAll must be passed function names");for(e=1;n>e;e++)i=arguments[e],t[i]=y.bind(t[i],t);return t},y.memoize=function(t,e){var i=function(n){var r=i.cache,s=""+(e?e.apply(this,arguments):n);return y.has(r,s)||(r[s]=t.apply(this,arguments)),r[s]};return i.cache={},i},y.delay=function(t,e){var i=u.call(arguments,2);return setTimeout(function(){return t.apply(null,i)},e)},y.defer=y.partial(y.delay,y,1),y.throttle=function(t,e,i){var n,r,s,a=null,o=0;i||(i={});var c=function(){o=i.leading===!1?0:y.now(),a=null,s=t.apply(n,r),a||(n=r=null)};return function(){var l=y.now();o||i.leading!==!1||(o=l);var u=e-(l-o);return n=this,r=arguments,0>=u||u>e?(a&&(clearTimeout(a),a=null),o=l,s=t.apply(n,r),a||(n=r=null)):a||i.trailing===!1||(a=setTimeout(c,u)),s}},y.debounce=function(t,e,i){var n,r,s,a,o,c=function(){var l=y.now()-a;e>l&&l>=0?n=setTimeout(c,e-l):(n=null,i||(o=t.apply(s,r),n||(s=r=null)))};return function(){s=this,r=arguments,a=y.now();var l=i&&!n;return n||(n=setTimeout(c,e)),l&&(o=t.apply(s,r),s=r=null),o}},y.wrap=function(t,e){return y.partial(e,t)},y.negate=function(t){return function(){return!t.apply(this,arguments)}},y.compose=function(){var t=arguments,e=t.length-1;return function(){for(var i=e,n=t[e].apply(this,arguments);i--;)n=t[i].call(this,n);return n}},y.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},y.before=function(t,e){var i;return function(){return--t>0&&(i=e.apply(this,arguments)),1>=t&&(e=null),i}},y.once=y.partial(y.before,2);var I=!{toString:null}.propertyIsEnumerable("toString"),L=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];y.keys=function(t){if(!y.isObject(t))return[];if(f)return f(t);var e=[];for(var i in t)y.has(t,i)&&e.push(i);return I&&n(t,e),e},y.allKeys=function(t){if(!y.isObject(t))return[];var e=[];for(var i in t)e.push(i);return I&&n(t,e),e},y.values=function(t){for(var e=y.keys(t),i=e.length,n=Array(i),r=0;i>r;r++)n[r]=t[e[r]];return n},y.mapObject=function(t,e,i){e=b(e,i);for(var n,r=y.keys(t),s=r.length,a={},o=0;s>o;o++)n=r[o],a[n]=e(t[n],n,t);return a},y.pairs=function(t){for(var e=y.keys(t),i=e.length,n=Array(i),r=0;i>r;r++)n[r]=[e[r],t[e[r]]];return n},y.invert=function(t){for(var e={},i=y.keys(t),n=0,r=i.length;r>n;n++)e[t[i[n]]]=i[n];return e},y.functions=y.methods=function(t){var e=[];for(var i in t)y.isFunction(t[i])&&e.push(i);return e.sort()},y.extend=w(y.allKeys),y.extendOwn=y.assign=w(y.keys),y.findKey=function(t,e,i){e=b(e,i);for(var n,r=y.keys(t),s=0,a=r.length;a>s;s++)if(n=r[s],e(t[n],n,t))return n},y.pick=function(t,e,i){var n,r,s={},a=t;if(null==a)return s;y.isFunction(e)?(r=y.allKeys(a),n=_(e,i)):(r=$(arguments,!1,!1,1),n=function(t,e,i){return e in i},a=Object(a));for(var o=0,c=r.length;c>o;o++){var l=r[o],u=a[l];n(u,l,a)&&(s[l]=u)}return s},y.omit=function(t,e,i){if(y.isFunction(e))e=y.negate(e);else{var n=y.map($(arguments,!1,!1,1),String);e=function(t,e){return!y.contains(n,e)}}return y.pick(t,e,i)},y.defaults=w(y.allKeys,!0),y.create=function(t,e){var i=k(t);return e&&y.extendOwn(i,e),i},y.clone=function(t){return y.isObject(t)?y.isArray(t)?t.slice():y.extend({},t):t},y.tap=function(t,e){return e(t),t},y.isMatch=function(t,e){var i=y.keys(e),n=i.length;if(null==t)return!n;for(var r=Object(t),s=0;n>s;s++){var a=i[s];if(e[a]!==r[a]||!(a in r))return!1}return!0};var E=function(t,e,i,n){if(t===e)return 0!==t||1/t===1/e;if(null==t||null==e)return t===e;t instanceof y&&(t=t._wrapped),e instanceof y&&(e=e._wrapped);var r=h.call(t);if(r!==h.call(e))return!1;switch(r){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!==+t?+e!==+e:0===+t?1/+t===1/e:+t===+e;case"[object Date]":case"[object Boolean]":return+t===+e}var s="[object Array]"===r;if(!s){if("object"!=typeof t||"object"!=typeof e)return!1;var a=t.constructor,o=e.constructor;if(a!==o&&!(y.isFunction(a)&&a instanceof a&&y.isFunction(o)&&o instanceof o)&&"constructor"in t&&"constructor"in e)return!1}i=i||[],n=n||[];for(var c=i.length;c--;)if(i[c]===t)return n[c]===e;if(i.push(t),n.push(e),s){if(c=t.length,c!==e.length)return!1;for(;c--;)if(!E(t[c],e[c],i,n))return!1}else{var l,u=y.keys(t);if(c=u.length,y.keys(e).length!==c)return!1;for(;c--;)if(l=u[c],!y.has(e,l)||!E(t[l],e[l],i,n))return!1}return i.pop(),n.pop(),!0};y.isEqual=function(t,e){return E(t,e)},y.isEmpty=function(t){return null==t||(P(t)&&(y.isArray(t)||y.isString(t)||y.isArguments(t))?0===t.length:0===y.keys(t).length)},y.isElement=function(t){return!(!t||1!==t.nodeType)},y.isArray=p||function(t){return"[object Array]"===h.call(t)},y.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},y.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(t){y["is"+t]=function(e){return h.call(e)==="[object "+t+"]"}}),y.isArguments(arguments)||(y.isArguments=function(t){return y.has(t,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(y.isFunction=function(t){return"function"==typeof t||!1}),y.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},y.isNaN=function(t){return y.isNumber(t)&&t!==+t},y.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"===h.call(t)},y.isNull=function(t){return null===t},y.isUndefined=function(t){return void 0===t},y.has=function(t,e){return null!=t&&d.call(t,e)},y.noConflict=function(){return r._=s,this},y.identity=function(t){return t},y.constant=function(t){return function(){return t}},y.noop=function(){},y.property=S,y.propertyOf=function(t){return null==t?function(){}:function(e){return t[e]}},y.matcher=y.matches=function(t){return t=y.extendOwn({},t),function(e){return y.isMatch(e,t)}},y.times=function(t,e,i){var n=Array(Math.max(0,t));e=_(e,i,1);for(var r=0;t>r;r++)n[r]=e(r);return n},y.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},y.now=Date.now||function(){return(new Date).getTime()};var j={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},M=y.invert(j),O=function(t){var e=function(e){return t[e]},i="(?:"+y.keys(t).join("|")+")",n=RegExp(i),r=RegExp(i,"g");return function(t){return t=null==t?"":""+t,n.test(t)?t.replace(r,e):t}};y.escape=O(j),y.unescape=O(M),y.result=function(t,e,i){var n=null==t?void 0:t[e];return void 0===n&&(n=i),y.isFunction(n)?n.call(t):n};var F=0;y.uniqueId=function(t){var e=++F+"";return t?t+e:e},y.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var R=/(.)^/,U={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\u2028|\u2029/g,N=function(t){return"\\"+U[t]};y.template=function(t,e,i){!e&&i&&(e=i),e=y.defaults({},e,y.templateSettings);var n=RegExp([(e.escape||R).source,(e.interpolate||R).source,(e.evaluate||R).source].join("|")+"|$","g"),r=0,s="__p+='";t.replace(n,function(e,i,n,a,o){return s+=t.slice(r,o).replace(D,N),r=o+e.length,i?s+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'":n?s+="'+\n((__t=("+n+"))==null?'':__t)+\n'":a&&(s+="';\n"+a+"\n__p+='"),e}),s+="';\n",e.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{var a=new Function(e.variable||"obj","_",s)}catch(o){throw o.source=s,o}var c=function(t){return a.call(this,t,y)},l=e.variable||"obj";return c.source="function("+l+"){\n"+s+"}",c},y.chain=function(t){var e=y(t);return e._chain=!0,e};var B=function(t,e){return t._chain?y(e).chain():e};y.mixin=function(t){y.each(y.functions(t),function(e){var i=y[e]=t[e];y.prototype[e]=function(){var t=[this._wrapped];return l.apply(t,arguments),B(this,i.apply(y,t))}})},y.mixin(y),y.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=a[t];y.prototype[t]=function(){var i=this._wrapped;return e.apply(i,arguments),"shift"!==t&&"splice"!==t||0!==i.length||delete i[0],B(this,i)}}),y.each(["concat","join","slice"],function(t){var e=a[t];y.prototype[t]=function(){return B(this,e.apply(this._wrapped,arguments))}}),y.prototype.value=function(){return this._wrapped},y.prototype.valueOf=y.prototype.toJSON=y.prototype.value,y.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return y})}).call(this),function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(i,n,r){e.Backbone=t(e,r,i,n)});else if("undefined"!=typeof exports){var i,n=require("underscore");try{i=require("jquery")}catch(r){}t(e,exports,n,i)}else e.Backbone=t(e,{},e._,e.jQuery||e.Zepto||e.ender||e.$)}(function(t,e,i,n){var r=t.Backbone,s=Array.prototype.slice;e.VERSION="1.2.3",e.$=n,e.noConflict=function(){return t.Backbone=r,this},e.emulateHTTP=!1,e.emulateJSON=!1;var a=function(t,e,n){switch(t){case 1:return function(){return i[e](this[n])};case 2:return function(t){return i[e](this[n],t)};case 3:return function(t,r){return i[e](this[n],c(t,this),r)};case 4:return function(t,r,s){return i[e](this[n],c(t,this),r,s)};default:return function(){var t=s.call(arguments);return t.unshift(this[n]),i[e].apply(i,t)}}},o=function(t,e,n){i.each(e,function(e,r){i[r]&&(t.prototype[r]=a(e,r,n))})},c=function(t,e){return i.isFunction(t)?t:i.isObject(t)&&!e._isModel(t)?l(t):i.isString(t)?function(e){return e.get(t)}:t},l=function(t){var e=i.matches(t);return function(t){return e(t.attributes)}},u=e.Events={},h=/\s+/,d=function(t,e,n,r,s){var a,o=0;if(n&&"object"==typeof n){void 0!==r&&"context"in s&&void 0===s.context&&(s.context=r);for(a=i.keys(n);o<a.length;o++)e=d(t,e,a[o],n[a[o]],s)}else if(n&&h.test(n))for(a=n.split(h);o<a.length;o++)e=t(e,a[o],r,s);else e=t(e,n,r,s);return e};u.on=function(t,e,i){return p(this,t,e,i)};var p=function(t,e,i,n,r){if(t._events=d(f,t._events||{},e,i,{context:n,ctx:t,listening:r}),r){var s=t._listeners||(t._listeners={});s[r.id]=r}return t};u.listenTo=function(t,e,n){if(!t)return this;var r=t._listenId||(t._listenId=i.uniqueId("l")),s=this._listeningTo||(this._listeningTo={}),a=s[r];if(!a){var o=this._listenId||(this._listenId=i.uniqueId("l"));a=s[r]={obj:t,objId:r,id:o,listeningTo:s,count:0}}return p(t,e,n,this,a),this};var f=function(t,e,i,n){if(i){var r=t[e]||(t[e]=[]),s=n.context,a=n.ctx,o=n.listening;o&&o.count++,r.push({callback:i,context:s,ctx:s||a,listening:o})}return t};u.off=function(t,e,i){return this._events?(this._events=d(v,this._events,t,e,{context:i,listeners:this._listeners}),this):this},u.stopListening=function(t,e,n){var r=this._listeningTo;if(!r)return this;for(var s=t?[t._listenId]:i.keys(r),a=0;a<s.length;a++){var o=r[s[a]];if(!o)break;o.obj.off(e,n,this)}return i.isEmpty(r)&&(this._listeningTo=void 0),this};var v=function(t,e,n,r){if(t){var s,a=0,o=r.context,c=r.listeners;if(e||n||o){for(var l=e?[e]:i.keys(t);a<l.length;a++){e=l[a];var u=t[e];if(!u)break;for(var h=[],d=0;d<u.length;d++){var p=u[d];n&&n!==p.callback&&n!==p.callback._callback||o&&o!==p.context?h.push(p):(s=p.listening,s&&0===--s.count&&(delete c[s.id],delete s.listeningTo[s.objId]))}h.length?t[e]=h:delete t[e]}return i.size(t)?t:void 0}for(var f=i.keys(c);a<f.length;a++)s=c[f[a]],delete c[s.id],delete s.listeningTo[s.objId]}};u.once=function(t,e,n){var r=d(g,{},t,e,i.bind(this.off,this));return this.on(r,void 0,n)},u.listenToOnce=function(t,e,n){var r=d(g,{},e,n,i.bind(this.stopListening,this,t));return this.listenTo(t,r)};var g=function(t,e,n,r){if(n){var s=t[e]=i.once(function(){r(e,s),n.apply(this,arguments)});s._callback=n}return t};u.trigger=function(t){if(!this._events)return this;for(var e=Math.max(0,arguments.length-1),i=Array(e),n=0;n<e;n++)i[n]=arguments[n+1];return d(m,this._events,t,void 0,i),this};var m=function(t,e,i,n){if(t){var r=t[e],s=t.all;r&&s&&(s=s.slice()),r&&y(r,n),s&&y(s,[e].concat(n))}return t},y=function(t,e){var i,n=-1,r=t.length,s=e[0],a=e[1],o=e[2];switch(e.length){case 0:for(;++n<r;)(i=t[n]).callback.call(i.ctx);return;case 1:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s);return;case 2:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s,a);return;case 3:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s,a,o);return;default:for(;++n<r;)(i=t[n]).callback.apply(i.ctx,e);return}};u.bind=u.on,u.unbind=u.off,i.extend(e,u);var _=e.Model=function(t,e){var n=t||{};e||(e={}),this.cid=i.uniqueId(this.cidPrefix),this.attributes={},e.collection&&(this.collection=e.collection),e.parse&&(n=this.parse(n,e)||{}),n=i.defaults({},n,i.result(this,"defaults")),this.set(n,e),this.changed={},this.initialize.apply(this,arguments)};i.extend(_.prototype,u,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(t){return i.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return i.escape(this.get(t))},has:function(t){return null!=this.get(t)},matches:function(t){return!!i.iteratee(t,this)(this.attributes)},set:function(t,e,n){if(null==t)return this;var r;if("object"==typeof t?(r=t,n=e):(r={})[t]=e,n||(n={}),!this._validate(r,n))return!1;var s=n.unset,a=n.silent,o=[],c=this._changing;this._changing=!0,c||(this._previousAttributes=i.clone(this.attributes),this.changed={});var l=this.attributes,u=this.changed,h=this._previousAttributes;for(var d in r)e=r[d],i.isEqual(l[d],e)||o.push(d),i.isEqual(h[d],e)?delete u[d]:u[d]=e,s?delete l[d]:l[d]=e;if(this.id=this.get(this.idAttribute),!a){o.length&&(this._pending=n);for(var p=0;p<o.length;p++)this.trigger("change:"+o[p],this,l[o[p]],n)}if(c)return this;if(!a)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,i.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var n in this.attributes)e[n]=void 0;return this.set(e,i.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!i.isEmpty(this.changed):i.has(this.changed,t)},changedAttributes:function(t){if(!t)return!!this.hasChanged()&&i.clone(this.changed);var e=this._changing?this._previousAttributes:this.attributes,n={};for(var r in t){var s=t[r];i.isEqual(e[r],s)||(n[r]=s)}return!!i.size(n)&&n},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(t){t=i.extend({parse:!0},t);var e=this,n=t.success;return t.success=function(i){var r=t.parse?e.parse(i,t):i;return!!e.set(r,t)&&(n&&n.call(t.context,e,i,t),void e.trigger("sync",e,i,t))},B(this,t),this.sync("read",this,t)},save:function(t,e,n){var r;null==t||"object"==typeof t?(r=t,n=e):(r={})[t]=e,n=i.extend({validate:!0,parse:!0},n);var s=n.wait;if(r&&!s){if(!this.set(r,n))return!1}else if(!this._validate(r,n))return!1;var a=this,o=n.success,c=this.attributes;n.success=function(t){a.attributes=c;var e=n.parse?a.parse(t,n):t;return s&&(e=i.extend({},r,e)),!(e&&!a.set(e,n))&&(o&&o.call(n.context,a,t,n),void a.trigger("sync",a,t,n))},B(this,n),r&&s&&(this.attributes=i.extend({},c,r));var l=this.isNew()?"create":n.patch?"patch":"update";"patch"!==l||n.attrs||(n.attrs=r);var u=this.sync(l,this,n);return this.attributes=c,u},destroy:function(t){t=t?i.clone(t):{};var e=this,n=t.success,r=t.wait,s=function(){e.stopListening(),e.trigger("destroy",e,e.collection,t)};t.success=function(i){r&&s(),n&&n.call(t.context,e,i,t),e.isNew()||e.trigger("sync",e,i,t)};var a=!1;return this.isNew()?i.defer(t.success):(B(this,t),a=this.sync("delete",this,t)),r||s(),a},url:function(){var t=i.result(this,"urlRoot")||i.result(this.collection,"url")||N();if(this.isNew())return t;var e=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(e)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},i.defaults({validate:!0},t))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=i.extend({},this.attributes,t);var n=this.validationError=this.validate(t,e)||null;return!n||(this.trigger("invalid",this,n,i.extend(e,{validationError:n})),!1)}});var b={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};o(_,b,"attributes");var w=e.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,i.extend({silent:!0},e))},k={add:!0,remove:!0,merge:!0},S={add:!0,remove:!1},x=function(t,e,i){i=Math.min(Math.max(i,0),t.length);for(var n=Array(t.length-i),r=e.length,s=0;s<n.length;s++)n[s]=t[s+i];for(s=0;s<r;s++)t[s+i]=e[s];for(s=0;s<n.length;s++)t[s+r+i]=n[s]};i.extend(w.prototype,u,{model:_,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,i.extend({merge:!1},e,S))},remove:function(t,e){e=i.extend({},e);var n=!i.isArray(t);t=n?[t]:i.clone(t);var r=this._removeModels(t,e);return!e.silent&&r&&this.trigger("update",this,e),n?r[0]:r},set:function(t,e){if(null!=t){e=i.defaults({},e,k),e.parse&&!this._isModel(t)&&(t=this.parse(t,e));var n=!i.isArray(t);t=n?[t]:t.slice();var r=e.at;null!=r&&(r=+r),r<0&&(r+=this.length+1);for(var s,a=[],o=[],c=[],l={},u=e.add,h=e.merge,d=e.remove,p=!1,f=this.comparator&&null==r&&e.sort!==!1,v=i.isString(this.comparator)?this.comparator:null,g=0;g<t.length;g++){s=t[g];var m=this.get(s);if(m){if(h&&s!==m){var y=this._isModel(s)?s.attributes:s;e.parse&&(y=m.parse(y,e)),m.set(y,e),f&&!p&&(p=m.hasChanged(v))}l[m.cid]||(l[m.cid]=!0,a.push(m)),t[g]=m}else u&&(s=t[g]=this._prepareModel(s,e),s&&(o.push(s),this._addReference(s,e),l[s.cid]=!0,a.push(s)))}if(d){for(g=0;g<this.length;g++)s=this.models[g],l[s.cid]||c.push(s);c.length&&this._removeModels(c,e)}var _=!1,b=!f&&u&&d;if(a.length&&b?(_=this.length!=a.length||i.some(this.models,function(t,e){return t!==a[e]}),this.models.length=0,x(this.models,a,0),this.length=this.models.length):o.length&&(f&&(p=!0),x(this.models,o,null==r?this.length:r),this.length=this.models.length),p&&this.sort({silent:!0}),!e.silent){for(g=0;g<o.length;g++)null!=r&&(e.index=r+g),s=o[g],s.trigger("add",s,this,e);(p||_)&&this.trigger("sort",this,e),(o.length||c.length)&&this.trigger("update",this,e)}return n?t[0]:t}},reset:function(t,e){e=e?i.clone(e):{};for(var n=0;n<this.models.length;n++)this._removeReference(this.models[n],e);return e.previousModels=this.models,this._reset(),t=this.add(t,i.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,i.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(t,e){return this.add(t,i.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return s.apply(this.models,arguments)},get:function(t){if(null!=t){var e=this.modelId(this._isModel(t)?t.attributes:t);return this._byId[t]||this._byId[e]||this._byId[t.cid]}},at:function(t){return t<0&&(t+=this.length),this.models[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(t){var e=this.comparator;if(!e)throw new Error("Cannot sort a set without a comparator");t||(t={});var n=e.length;return i.isFunction(e)&&(e=i.bind(e,this)),1===n||i.isString(e)?this.models=this.sortBy(e):this.models.sort(e),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return i.invoke(this.models,"get",t)},fetch:function(t){t=i.extend({parse:!0},t);var e=t.success,n=this;return t.success=function(i){var r=t.reset?"reset":"set";n[r](i,t),e&&e.call(t.context,n,i,t),n.trigger("sync",n,i,t)},B(this,t),this.sync("read",this,t)},create:function(t,e){e=e?i.clone(e):{};var n=e.wait;if(t=this._prepareModel(t,e),!t)return!1;n||this.add(t,e);var r=this,s=e.success;return e.success=function(t,e,i){n&&r.add(t,i),s&&s.call(i.context,t,e,i)},t.save(null,e),t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(t){return t[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(this._isModel(t))return t.collection||(t.collection=this),t;e=e?i.clone(e):{},e.collection=this;var n=new this.model(t,e);return n.validationError?(this.trigger("invalid",this,n.validationError,e),!1):n},_removeModels:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=this.get(t[n]);if(r){var s=this.indexOf(r);this.models.splice(s,1),this.length--,e.silent||(e.index=s,r.trigger("remove",r,this,e)),i.push(r),this._removeReference(r,e)}}return!!i.length&&i},_isModel:function(t){return t instanceof _},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.modelId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onModelEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.modelId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,n){if("add"!==t&&"remove"!==t||i===this){if("destroy"===t&&this.remove(e,n),"change"===t){var r=this.modelId(e.previousAttributes()),s=this.modelId(e.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=e))}this.trigger.apply(this,arguments)}}});var T={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3};o(w,T,"models");var P=e.View=function(t){this.cid=i.uniqueId("view"),i.extend(this,i.pick(t,$)),this._ensureElement(),this.initialize.apply(this,arguments)},C=/^(\S+)\s*(.*)$/,$=["model","collection","el","id","attributes","className","tagName","events"];i.extend(P.prototype,u,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(t){return this.undelegateEvents(),this._setElement(t),this.delegateEvents(),this},_setElement:function(t){this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0]},delegateEvents:function(t){if(t||(t=i.result(this,"events")),!t)return this;this.undelegateEvents();for(var e in t){var n=t[e];if(i.isFunction(n)||(n=this[n]),n){var r=e.match(C);this.delegate(r[1],r[2],i.bind(n,this))}}return this},delegate:function(t,e,i){return this.$el.on(t+".delegateEvents"+this.cid,e,i),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),
this},undelegate:function(t,e,i){return this.$el.off(t+".delegateEvents"+this.cid,e,i),this},_createElement:function(t){return document.createElement(t)},_ensureElement:function(){if(this.el)this.setElement(i.result(this,"el"));else{var t=i.extend({},i.result(this,"attributes"));this.id&&(t.id=i.result(this,"id")),this.className&&(t["class"]=i.result(this,"className")),this.setElement(this._createElement(i.result(this,"tagName"))),this._setAttributes(t)}},_setAttributes:function(t){this.$el.attr(t)}}),e.sync=function(t,n,r){var s=A[t];i.defaults(r||(r={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var a={type:s,dataType:"json"};if(r.url||(a.url=i.result(n,"url")||N()),null!=r.data||!n||"create"!==t&&"update"!==t&&"patch"!==t||(a.contentType="application/json",a.data=JSON.stringify(r.attrs||n.toJSON(r))),r.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{model:a.data}:{}),r.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){a.type="POST",r.emulateJSON&&(a.data._method=s);var o=r.beforeSend;r.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",s),o)return o.apply(this,arguments)}}"GET"===a.type||r.emulateJSON||(a.processData=!1);var c=r.error;r.error=function(t,e,i){r.textStatus=e,r.errorThrown=i,c&&c.call(r.context,t,e,i)};var l=r.xhr=e.ajax(i.extend(a,r));return n.trigger("request",n,l,r),l};var A={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var I=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},L=/\((.*?)\)/g,E=/(\(\?)?:\w+/g,j=/\*\w+/g,M=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend(I.prototype,u,{initialize:function(){},route:function(t,n,r){i.isRegExp(t)||(t=this._routeToRegExp(t)),i.isFunction(n)&&(r=n,n=""),r||(r=this[n]);var s=this;return e.history.route(t,function(i){var a=s._extractParameters(t,i);s.execute(r,a,n)!==!1&&(s.trigger.apply(s,["route:"+n].concat(a)),s.trigger("route",n,a),e.history.trigger("route",s,n,a))}),this},execute:function(t,e,i){t&&t.apply(this,e)},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var t,e=i.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(M,"\\$&").replace(L,"(?:$1)?").replace(E,function(t,e){return e?t:"([^/?]+)"}).replace(j,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return i.map(n,function(t,e){return e===n.length-1?t||null:t?decodeURIComponent(t):null})}});var O=e.History=function(){this.handlers=[],this.checkUrl=i.bind(this.checkUrl,this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},F=/^[#\/]|\s+$/g,R=/^\/+|\/+$/g,U=/#.*$/;O.started=!1,i.extend(O.prototype,u,{interval:50,atRoot:function(){var t=this.location.pathname.replace(/[^\/]$/,"$&/");return t===this.root&&!this.getSearch()},matchRoot:function(){var t=this.decodeFragment(this.location.pathname),e=t.slice(0,this.root.length-1)+"/";return e===this.root},decodeFragment:function(t){return decodeURI(t.replace(/%25/g,"%2525"))},getSearch:function(){var t=this.location.href.replace(/#.*/,"").match(/\?.+/);return t?t[0]:""},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getPath:function(){var t=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===t.charAt(0)?t.slice(1):t},getFragment:function(t){return null==t&&(t=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),t.replace(F,"")},start:function(t){if(O.started)throw new Error("Backbone.history has already been started");if(O.started=!0,this.options=i.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._hasHashChange="onhashchange"in window&&(void 0===document.documentMode||document.documentMode>7),this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(R,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var e=this.root.slice(0,-1)||"/";return this.location.replace(e+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var n=document.body,r=n.insertBefore(this.iframe,n.firstChild).contentWindow;r.document.open(),r.document.close(),r.location.hash="#"+this.fragment}var s=window.addEventListener||function(t,e){return attachEvent("on"+t,e)};if(this._usePushState?s("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?s("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var t=window.removeEventListener||function(t,e){return detachEvent("on"+t,e)};this._usePushState?t("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&t("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),O.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getHash(this.iframe.contentWindow)),e!==this.fragment&&(this.iframe&&this.navigate(e),void this.loadUrl())},loadUrl:function(t){return!!this.matchRoot()&&(t=this.fragment=this.getFragment(t),i.some(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0}))},navigate:function(t,e){if(!O.started)return!1;e&&e!==!0||(e={trigger:!!e}),t=this.getFragment(t||"");var i=this.root;""!==t&&"?"!==t.charAt(0)||(i=i.slice(0,-1)||"/");var n=i+t;if(t=this.decodeFragment(t.replace(U,"")),this.fragment!==t){if(this.fragment=t,this._usePushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);if(this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getHash(this.iframe.contentWindow)){var r=this.iframe.contentWindow;e.replace||(r.document.open(),r.document.close()),this._updateHash(r.location,t,e.replace)}}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,i){if(i){var n=t.href.replace(/(javascript:|#).*$/,"");t.replace(n+"#"+e)}else t.hash="#"+e}}),e.history=new O;var D=function(t,e){var n,r=this;n=t&&i.has(t,"constructor")?t.constructor:function(){return r.apply(this,arguments)},i.extend(n,r,e);var s=function(){this.constructor=n};return s.prototype=r.prototype,n.prototype=new s,t&&i.extend(n.prototype,t),n.__super__=r.prototype,n};_.extend=w.extend=I.extend=P.extend=O.extend=D;var N=function(){throw new Error('A "url" property or function must be specified')},B=function(t,e){var i=e.error;e.error=function(n){i&&i.call(e.context,t,n,e),t.trigger("error",t,n,e)}};return e}),function(t){"function"==typeof define&&define.amd?define(["backbone","underscore"],t):"object"==typeof exports?module.exports=t(require("backbone"),require("underscore")):t(window.Backbone,window._)}(function(t,e){var i=t.Router.prototype.route,n=function(){};e.extend(t.Router.prototype,{before:n,after:n,route:function(t,r,s){s||(s=this[r]);var a=e.bind(function(){var i,r=[t,e.toArray(arguments)];if(i=e.isFunction(this.before)?this.before:"undefined"!=typeof this.before[t]?this.before[t]:n,i.apply(this,r)!==!1){s&&s.apply(this,arguments);var a;a=e.isFunction(this.after)?this.after:"undefined"!=typeof this.after[t]?this.after[t]:n,a.apply(this,r)}},this);return i.call(this,t,r,a)}})}),function(t){var e=!1;if("function"==typeof define&&define.amd&&(define(t),e=!0),"object"==typeof exports&&(module.exports=t(),e=!0),!e){var i=window.Cookies,n=window.Cookies=t();n.noConflict=function(){return window.Cookies=i,n}}}(function(){function t(){for(var t=0,e={};t<arguments.length;t++){var i=arguments[t];for(var n in i)e[n]=i[n]}return e}function e(i){function n(e,r,s){var a;if("undefined"!=typeof document){if(arguments.length>1){if(s=t({path:"/"},n.defaults,s),"number"==typeof s.expires){var o=new Date;o.setMilliseconds(o.getMilliseconds()+864e5*s.expires),s.expires=o}s.expires=s.expires?s.expires.toUTCString():"";try{a=JSON.stringify(r),/^[\{\[]/.test(a)&&(r=a)}catch(c){}r=i.write?i.write(r,e):encodeURIComponent(String(r)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),e=encodeURIComponent(String(e)),e=e.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),e=e.replace(/[\(\)]/g,escape);var l="";for(var u in s)s[u]&&(l+="; "+u,s[u]!==!0&&(l+="="+s[u]));return document.cookie=e+"="+r+l}e||(a={});for(var h=document.cookie?document.cookie.split("; "):[],d=/(%[0-9A-Z]{2})+/g,p=0;p<h.length;p++){var f=h[p].split("="),v=f.slice(1).join("=");this.json||'"'!==v.charAt(0)||(v=v.slice(1,-1));try{var g=f[0].replace(d,decodeURIComponent);if(v=i.read?i.read(v,g):i(v,g)||v.replace(d,decodeURIComponent),this.json)try{v=JSON.parse(v)}catch(c){}if(e===g){a=v;break}e||(a[g]=v)}catch(c){}}return a}}return n.set=n,n.get=function(t){return n.call(n,t)},n.getJSON=function(){return n.apply({json:!0},[].slice.call(arguments))},n.defaults={},n.remove=function(e,i){n(e,"",t(i,{expires:-1}))},n.withConverter=e,n}return e(function(){})}),function(t){if("function"==typeof require&&"object"==typeof exports&&"object"==typeof module){try{var e=require("jquery")}catch(i){}module.exports=t(e)}else if("function"==typeof define&&define.amd)define(["jquery"],function(e){return t(e)});else{var n;try{n=(0,eval)("this")}catch(i){n=window}n.deparam=t(n.jQuery)}}(function(t){var e=function(t,e){var i={},n={"true":!0,"false":!1,"null":null};return t.replace(/\+/g," ").split("&").forEach(function(t){var r,s=t.split("="),a=decodeURIComponent(s[0]),o=i,c=0,l=a.split("]["),u=l.length-1;if(/\[/.test(l[0])&&/\]$/.test(l[u])?(l[u]=l[u].replace(/\]$/,""),l=l.shift().split("[").concat(l),u=l.length-1):u=0,2===s.length)if(r=decodeURIComponent(s[1]),e&&(r=r&&!isNaN(r)&&+r+""===r?+r:"undefined"===r?void 0:void 0!==n[r]?n[r]:r),u)for(;c<=u;c++)a=""===l[c]?o.length:l[c],o=o[a]=c<u?o[a]||(l[c+1]&&isNaN(l[c+1])?{}:[]):r;else"[object Array]"===Object.prototype.toString.call(i[a])?i[a].push(r):{}.hasOwnProperty.call(i,a)?i[a]=[i[a],r]:i[a]=r;else a&&(i[a]=e?void 0:"")}),i};return t&&(t.prototype.deparam=t.deparam=e),e}),function(t,e){"object"==typeof exports&&module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PubSub=e()}("object"==typeof window&&window||this,function(){function t(t){var e;for(e in t)if(t.hasOwnProperty(e))return!0;return!1}function e(t){return function(){throw t}}function i(t,i,n){try{t(i,n)}catch(r){setTimeout(e(r),0)}}function n(t,e,i){t(e,i)}function r(t,e,r,s){var a,o=l[e],c=s?n:i;if(l.hasOwnProperty(e))for(a in o)o.hasOwnProperty(a)&&c(o[a],t,r)}function s(t,e,i){return function(){var n=String(t),s=n.lastIndexOf(".");for(r(t,t,e,i);s!==-1;)n=n.substr(0,s),s=n.lastIndexOf("."),r(t,n,e)}}function a(e){for(var i=String(e),n=Boolean(l.hasOwnProperty(i)&&t(l[i])),r=i.lastIndexOf(".");!n&&r!==-1;)i=i.substr(0,r),r=i.lastIndexOf("."),n=Boolean(l.hasOwnProperty(i)&&t(l[i]));return n}function o(t,e,i,n){var r=s(t,e,n),o=a(t);return!!o&&(i===!0?r():setTimeout(r,0),!0)}var c={},l={},u=-1;return c.publish=function(t,e){return o(t,e,!1,c.immediateExceptions)},c.publishSync=function(t,e){return o(t,e,!0,c.immediateExceptions)},c.subscribe=function(t,e){if("function"!=typeof e)return!1;l.hasOwnProperty(t)||(l[t]={});var i="uid_"+String(++u);return l[t][i]=e,i},c.unsubscribe=function(t){var e,i,n,r="string"==typeof t,s=!1;for(e in l)if(l.hasOwnProperty(e)){if(i=l[e],r&&i[t]){delete i[t],s=t;break}if(!r)for(n in i)i.hasOwnProperty(n)&&i[n]===t&&(delete i[n],s=!0)}return s},c}),function(t){"function"==typeof define&&define.amd?define(["jquery","jquery-deparam","pubsub-js","js-cookie"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("jquery-deparam"),require("pubsub-js"),require("js-cookie")):t(window.jQuery,window.deparam,window.PubSub,window.Cookies)}(function(t,e,i,n){var r=Function("return this")();if(r.auth)return r.auth;var s=r.navigator,a="default",o="currentConfigName",c="authHeaders",l="firstTimeLogin",u="mustResetPassword",h="auth.validation.success",d="auth.validation.error",p="auth.emailRegistration.success",f="auth.emailRegistration.error",v="auth.passwordResetRequest.success",g="auth.passwordResetRequest.error",m="auth.emailConfirmation.success",y="auth.emailConfirmation.error",_="auth.passwordResetConfirm.success",b="auth.passwordResetConfirm.error",w="auth.emailSignIn.success",k="auth.emailSignIn.error",S="auth.oAuthSignIn.success",x="auth.oAuthSignIn.error",T="auth.signIn.success",P="auth.signIn.error",C="auth.signOut.success",$="auth.signOut.error",A="auth.accountUpdate.success",I="auth.accountUpdate.error",L="auth.destroyAccount.success",E="auth.destroyAccount.error",j="auth.passwordUpdate.success",M="auth.passwordUpdate.error",O=function(){this.configured=!1,this.configDfd=null,this.configs={},this.defaultConfigKey=null,this.firstTimeLogin=!1,this.mustResetPassword=!1,this.user={},this.oAuthDfd=null,this.oAuthTimer=null,this.configBase={apiUrl:"/api",signOutPath:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",forceHardRedirect:!1,storage:"cookies",cookieExpiry:14,cookiePath:"/",initialCredentials:null,passwordResetSuccessUrl:function(){return r.location.href},confirmationSuccessUrl:function(){return r.location.href},tokenFormat:{"access-token":"{{ access-token }}","token-type":"Bearer",client:"{{ client }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(t){return 1e3*parseInt(t.expiry,10)||null},handleLoginResponse:function(t){return t.data},handleAccountUpdateResponse:function(t){return t.data},handleTokenValidationResponse:function(t){return t.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}};O.prototype.reset=function(){this.destroySession(),this.configs={},this.defaultConfigKey=null,this.configured=!1,this.configDfd=null,this.mustResetPassword=!1,this.firstTimeLogin=!1,this.oAuthDfd=null,this.willRedirect=!1,this.oAuthTimer&&(clearTimeout(this.oAuthTimer),this.oAuthTimer=null);for(var e in this.user)delete this.user[e];t(document).unbind("ajaxComplete",this.updateAuthCredentials),r.removeEventListener&&r.removeEventListener("message",this.handlePostMessage),t.ajaxSetup({beforeSend:void 0})},O.prototype.invalidateTokens=function(){for(var t in this.user)delete this.user[t];this.deleteData(o),this.deleteData(c)},O.prototype.checkDependencies=function(){var s=[],a=[];if(!t)throw"jToker: jQuery not found. This module depends on jQuery.";if(r.localStorage||n||s.push("This browser does not support localStorage. You must install js-cookie to use jToker with this browser."),e||s.push("Dependency not met: jquery-deparam."),i||a.push("jquery.ba-tinypubsub.js not found. No auth events will be broadcast."),s.length){var o=s.join(" ");throw"jToker: Please resolve the following errors: "+o}if(a.length&&console&&console.warn){var c=a.join(" ");console.warn("jToker: Warning: "+c)}},O.prototype.destroySession=function(){var t=[c,o];for(var e in t)if(e=t[e],r.localStorage&&r.localStorage.removeItem(e),n){for(var i in this.configs){var s=this.configs[i].cookiePath;n.remove(e,{path:s})}n.remove(e,{path:"/"})}},O.prototype.configure=function(e,i){if(i&&this.reset(),this.configured)return this.configDfd;if(this.configured=!0,e||(e={}),e.constructor!==Array){this.defaultConfigKey=a;var n={};n[this.defaultConfigKey]=e,e=[n]}for(var s=0;s<e.length;s++){var o=F(e[s]);this.defaultConfigKey||(this.defaultConfigKey=o),this.configs[o]=t.extend({},this.configBase,e[s][o])}if(this.checkDependencies(),t(document).ajaxComplete(r.auth.updateAuthCredentials),t.ajaxSetup({beforeSend:r.auth.appendAuthHeaders}),r.addEventListener&&r.addEventListener("message",this.handlePostMessage,!1),this.processSearchParams(),this.willRedirect)return!1;if(this.getConfig().initialCredentials){var h=this.getConfig();return this.persistData(c,h.initialCredentials.headers),this.persistData(u,h.initialCredentials.mustResetPassword),this.persistData(l,h.initialCredentials.firstTimeLogin),this.setCurrentUser(h.initialCredentials.user),(new t.Deferred).resolve(h.initialCredentials.user)}return this.configDfd=this.validateToken({config:this.getCurrentConfigName()}),this.configDfd},O.prototype.getApiUrl=function(){var t=this.getConfig();return t.proxyIf()?t.proxyUrl:t.apiUrl},O.prototype.buildAuthHeaders=function(t){var e={},i=this.getConfig().tokenFormat;for(var n in i)e[n]=D(i[n],t);return e},O.prototype.setCurrentUser=function(e){for(var i in this.user)delete this.user[i];return t.extend(this.user,e),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),this.user},O.prototype.handlePostMessage=function(t){var e=!1;if("deliverCredentials"===t.data.message){delete t.data.message;var i=r.auth.normalizeTokenKeys(t.data),n=r.auth.buildAuthHeaders(i),s=r.auth.setCurrentUser(t.data);r.auth.persistData(c,n),r.auth.resolvePromise(S,r.auth.oAuthDfd,s),r.auth.broadcastEvent(T,s),r.auth.broadcastEvent(h,s),e=!0}"authFailure"===t.data.message&&(r.auth.rejectPromise(x,r.auth.oAuthDfd,t.data,"OAuth authentication failed."),r.auth.broadcastEvent(P,t.data),e=!0),e&&(clearTimeout(r.auth.oAuthTimer),r.auth.oAuthTimer=null)},O.prototype.normalizeTokenKeys=function(t){return t.token&&(t["access-token"]=t.token,delete t.token),t.auth_token&&(t["access-token"]=t.auth_token,delete t.auth_token),t.client_id&&(t.client=t.client_id,delete t.client_id),t.config&&(this.persistData(o,t.config,t.config),delete t.config),t},O.prototype.processSearchParams=function(){var t=this.getQs(),e=null;if(t=this.normalizeTokenKeys(t),t["access-token"]&&t.uid){e=this.buildAuthHeaders(t),this.persistData(c,e),t.reset_password&&this.persistData(u,!0),t.account_confirmation_success&&this.persistData(l,!0);var i=this.getLocationWithoutParams(["access-token","token","auth_token","config","client","client_id","expiry","uid","reset_password","account_confirmation_success"]);this.willRedirect=!0,this.setLocation(i)}return e},O.prototype.getLocationWithoutParams=function(e){var i=t.param(this.stripKeys(this.getSearchQs(),e)),n=t.param(this.stripKeys(this.getAnchorQs(),e)),s=r.location.hash.split("?")[0];i&&(i="?"+i),n&&(s+="?"+n),s&&!s.match(/^#/)&&(s="#/"+s);var a=r.location.protocol+"//"+r.location.host+r.location.pathname+i+s;return a},O.prototype.stripKeys=function(t,e){for(var i in e)delete t[e[i]];return t},O.prototype.broadcastEvent=function(t,e){i.publish&&i.publish(t,e)},O.prototype.resolvePromise=function(e,i,n){var r=this,s=t.Deferred();return setTimeout(function(){r.broadcastEvent(e,n),i.resolve(n),s.resolve()},0),s.promise()},O.prototype.rejectPromise=function(e,i,n,r){var s=this;return n=t.parseJSON(n&&n.responseText||"{}"),setTimeout(function(){s.broadcastEvent(e,n),i.reject({reason:r,data:n})},0),i},O.prototype.validateToken=function(e){if(e||(e={}),e.config||(e.config=this.getCurrentConfigName()),this.configDfd)return this.configDfd;var i=t.Deferred();if(this.retrieveData(c)){var n=this.getConfig(e.config),r=this.getApiUrl()+n.tokenValidationPath;t.ajax({url:r,context:this,success:function(t){var e=n.handleTokenValidationResponse(t);this.setCurrentUser(e),this.retrieveData(l)&&(this.broadcastEvent(m,t),this.persistData(l,!1),this.firstTimeLogin=!0),this.retrieveData(u)&&(this.broadcastEvent(_,t),this.persistData(u,!1),this.mustResetPassword=!0),this.resolvePromise(h,i,this.user)},error:function(t){this.invalidateTokens(),this.retrieveData(l)&&(this.broadcastEvent(y,t),this.persistData(l,!1)),this.retrieveData(u)&&(this.broadcastEvent(b,t),this.persistData(u,!1)),this.rejectPromise(d,i,t,"Cannot validate token; token rejected by server.")}})}else this.invalidateTokens(),this.rejectPromise(d,i,{},"Cannot validate token; no token found.");return i.promise()},O.prototype.emailSignUp=function(e){e||(e={});var i=this.getConfig(e.config),n=this.getApiUrl()+i.emailRegistrationPath,r=t.Deferred();return e.config_name=e.config,delete e.config,e.confirm_success_url=i.confirmationSuccessUrl(),t.ajax({url:n,context:this,method:"POST",data:e,success:function(t){this.resolvePromise(p,r,t)},error:function(t){this.rejectPromise(f,r,t,"Failed to submit email registration.")}}),r.promise()},O.prototype.emailSignIn=function(e){e||(e={});var i=this.getConfig(e.config),n=this.getApiUrl()+i.emailSignInPath,r=t.Deferred();return delete e.config,t.ajax({url:n,context:this,method:"POST",data:e,success:function(t){var e=i.handleLoginResponse(t);this.setCurrentUser(e),this.resolvePromise(w,r,t),this.broadcastEvent(T,e),this.broadcastEvent(h,this.user)},error:function(t){this.rejectPromise(k,r,t,"Invalid credentials."),this.broadcastEvent(P,t)}}),r.promise()},O.prototype.listenForCredentials=function(t){var e=this;t.closed?e.rejectPromise(x,e.oAuthDfd,null,"OAuth window was closed bofore registration was completed."):(t.postMessage("requestCredentials","*"),e.oAuthTimer=setTimeout(function(){e.listenForCredentials(t)},500))},O.prototype.openAuthWindow=function(t){if(this.getConfig().forceHardRedirect||r.isIE())this.setLocation(t);else{var e=this.createPopup(t);this.listenForCredentials(e)}},O.prototype.buildOAuthUrl=function(t,e,i){var n=this.getConfig().apiUrl+i+"?auth_origin_url="+encodeURIComponent(r.location.href)+"&config_name="+encodeURIComponent(t||this.getCurrentConfigName())+"&omniauth_window_type=newWindow";if(e)for(var s in e)n+="&",n+=encodeURIComponent(s),n+="=",n+=encodeURIComponent(e[s]);return n},O.prototype.oAuthSignIn=function(e){if(e||(e={}),!e.provider)throw"jToker: provider param undefined for `oAuthSignIn` method.";var i=this.getConfig(e.config),n=i.authProviderPaths[e.provider],r=this.buildOAuthUrl(e.config,e.params,n);if(!n)throw"jToker: providerPath not found for provider: "+e.provider;return this.oAuthDfd=t.Deferred(),this.openAuthWindow(r),this.oAuthDfd.promise()},O.prototype.signOut=function(e){e||(e={});var i=this.getConfig(e.config),n=this.getApiUrl()+i.signOutPath,r=t.Deferred();return t.ajax({url:n,context:this,method:"DELETE",success:function(t){this.resolvePromise(C,r,t)},error:function(t){this.rejectPromise($,r,t,"Failed to sign out.")},complete:function(){this.invalidateTokens()}}),r.promise()},O.prototype.updateAccount=function(e){e||(e={});var i=this.getConfig(e.config),n=this.getApiUrl()+i.accountUpdatePath,r=t.Deferred();return delete e.config,t.ajax({url:n,context:this,method:"PUT",data:e,success:function(t){var e=i.handleAccountUpdateResponse(t);this.setCurrentUser(e),this.resolvePromise(A,r,t)},error:function(t){this.rejectPromise(I,r,t,"Failed to update user account")}}),r.promise()},O.prototype.destroyAccount=function(e){e||(e={});var i=this.getConfig(e.config),n=this.getApiUrl()+i.accountDeletePath,r=t.Deferred();return t.ajax({url:n,context:this,method:"DELETE",success:function(t){this.invalidateTokens(),this.resolvePromise(L,r,t)},error:function(t){this.rejectPromise(E,r,t,"Failed to destroy user account")}}),r.promise()},O.prototype.requestPasswordReset=function(e){if(e||(e={}),void 0===e.email)throw"jToker: email param undefined for `requestPasswordReset` method.";var i=this.getConfig(e.config),n=this.getApiUrl()+i.passwordResetPath,r=t.Deferred();return e.config_name=e.config,delete e.config,e.redirect_url=i.passwordResetSuccessUrl(),t.ajax({url:n,context:this,method:"POST",data:e,success:function(t){this.resolvePromise(v,r,t)},error:function(t){this.rejectPromise(g,r,t,"Failed to submit email registration.")}}),r.promise()},O.prototype.updatePassword=function(e){e||(e={});var i=this.getConfig(e.config),n=this.getApiUrl()+i.passwordUpdatePath,r=t.Deferred();return delete e.config,t.ajax({url:n,context:this,method:"PUT",data:e,success:function(t){this.resolvePromise(j,r,t)},error:function(t){this.rejectPromise(M,r,t,"Failed to update password.")}}),r.promise()},O.prototype.persistData=function(t,e,i){switch(e=JSON.stringify(e),this.getConfig(i).storage){case"localStorage":r.localStorage.setItem(t,e);break;default:n.set(t,e,{expires:this.getConfig(i).cookieExpiry,path:this.getConfig(i).cookiePath})}},O.prototype.retrieveData=function(e){var i=null;switch(this.getConfig().storage){case"localStorage":i=r.localStorage.getItem(e);break;default:i=n.get(e)}try{return t.parseJSON(i)}catch(s){return R(i)}},O.prototype.getCurrentConfigName=function(){var t=null;return this.getQs().config&&(t=this.getQs().config),n&&!t&&(t=n.get(o)),r.localStorage&&!t&&(t=r.localStorage.getItem(o)),t=t||this.defaultConfigKey||a,R(t)},O.prototype.deleteData=function(t){switch(this.getConfig().storage){case"cookies":n.remove(t,{path:this.getConfig().cookiePath});break;default:r.localStorage.removeItem(t)}},O.prototype.getConfig=function(t){if(!this.configured)throw"jToker: `configure` must be run before using this plugin.";return t=t||this.getCurrentConfigName(),this.configs[t]},O.prototype.appendAuthHeaders=function(t,e){var i=r.auth.retrieveData(c);if(U(e.url)&&i){t.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT");for(var n in r.auth.getConfig().tokenFormat)t.setRequestHeader(n,i[n])}},O.prototype.updateAuthCredentials=function(t,e,i){if(U(i.url)){var n={},s=!0;for(var a in r.auth.getConfig().tokenFormat)n[a]=e.getResponseHeader(a),n[a]&&(s=!1);s||r.auth.persistData(c,n)}},O.prototype.getRawSearch=function(){return r.location.search},O.prototype.getRawAnchor=function(){return r.location.hash},O.prototype.setRawAnchor=function(t){r.location.hash=t},O.prototype.getAnchorSearch=function(){var t=this.getRawAnchor().split("?");return t.length>1?t[1]:null},O.prototype.setRawSearch=function(t){r.location.search=t},O.prototype.setSearchQs=function(e){return this.setRawSearch(t.param(e)),this.getSearchQs()},O.prototype.setAnchorQs=function(e){return this.setAnchorSearch(t.param(e)),this.getAnchorQs()},O.prototype.setLocation=function(t){r.location.replace(t)},O.prototype.createPopup=function(t){return r.open(t)},O.prototype.getSearchQs=function(){var t=this.getRawSearch().replace("?",""),i=t?e(t):{};return i},O.prototype.getAnchorQs=function(){var t=this.getAnchorSearch(),i=t?e(t):{};return i},O.prototype.getQs=function(){return t.extend(this.getSearchQs(),this.getAnchorQs())};var F=function(t){for(var e in t)return e},R=function(t){return t&&t.replace(/("|')/g,"")},U=function(t){return t.match(r.auth.getApiUrl())},D=function(t,e){for(var i=function(t,i){return void 0===e[i]?t:e[i]},n=new RegExp("{{\\s*([a-z0-9-_]+)\\s*}}","ig"),r="";r!==t;t=(r=t).replace(n,i));return t};return r.isOldIE=function(){var t=!1,e=s.userAgent.toLowerCase();if(e&&e.indexOf("msie")!==-1){var i=parseInt(e.split("msie")[1]);i<10&&(t=!0)}return t},r.isIE=function(){var t=r.isOldIE(),e=!!s.userAgent.match(/Trident.*rv\:11\./);return t||e},r.auth=t.auth=new O,r.auth}),!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Fuse",[],e):"object"==typeof exports?exports.Fuse=e():t.Fuse=e()}(this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var i={};return e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,n){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var i=t&&t.__esModule?function(){return t["default"]}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=8)}([function(t,e,i){"use strict";t.exports=function(t){return"[object Array]"===Object.prototype.toString.call(t)}},function(t,e,i){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),s=i(5),a=i(7),o=i(4),c=function(){function t(e,i){var r=i.location,s=void 0===r?0:r,a=i.distance,c=void 0===a?100:a,l=i.threshold,u=void 0===l?.6:l,h=i.maxPatternLength,d=void 0===h?32:h,p=i.isCaseSensitive,f=void 0!==p&&p,v=i.tokenSeparator,g=void 0===v?/ +/g:v,m=i.findAllMatches,y=void 0!==m&&m,_=i.minMatchCharLength,b=void 0===_?1:_;n(this,t),this.options={location:s,distance:c,threshold:u,maxPatternLength:d,isCaseSensitive:f,tokenSeparator:g,findAllMatches:y,minMatchCharLength:b},this.pattern=this.options.isCaseSensitive?e:e.toLowerCase(),this.pattern.length<=d&&(this.patternAlphabet=o(this.pattern))}return r(t,[{key:"search",value:function(t){if(this.options.isCaseSensitive||(t=t.toLowerCase()),this.pattern===t)return{isMatch:!0,score:0,matchedIndices:[[0,t.length-1]]};var e=this.options,i=e.maxPatternLength,n=e.tokenSeparator;if(this.pattern.length>i)return s(t,this.pattern,n);var r=this.options,o=r.location,c=r.distance,l=r.threshold,u=r.findAllMatches,h=r.minMatchCharLength;return a(t,this.pattern,this.patternAlphabet,{location:o,distance:c,threshold:l,findAllMatches:u,minMatchCharLength:h})}}]),t}();t.exports=c},function(t,e,i){"use strict";var n=i(0),r=function s(t,e,i){if(e){var r=e.indexOf("."),a=e,o=null;-1!==r&&(a=e.slice(0,r),o=e.slice(r+1));var c=t[a];if(null!==c&&void 0!==c)if(o||"string"!=typeof c&&"number"!=typeof c)if(n(c))for(var l=0,u=c.length;l<u;l+=1)s(c[l],o,i);else o&&s(c,o,i);else i.push(c)}else i.push(t);return i};t.exports=function(t,e){return r(t,e,[])}},function(t,e,i){"use strict";t.exports=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=[],n=-1,r=-1,s=0,a=t.length;s<a;s+=1){var o=t[s];o&&-1===n?n=s:o||-1===n||(r=s-1,r-n+1>=e&&i.push([n,r]),n=-1)}return t[s-1]&&s-n>=e&&i.push([n,s-1]),i}},function(t,e,i){"use strict";t.exports=function(t){for(var e={},i=t.length,n=0;n<i;n+=1)e[t.charAt(n)]=0;for(var r=0;r<i;r+=1)e[t.charAt(r)]|=1<<i-r-1;return e}},function(t,e,i){"use strict";t.exports=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:/ +/g,n=t.match(new RegExp(e.replace(i,"|"))),r=!!n,s=[];if(r)for(var a=0,o=n.length;a<o;a+=1)match=n[a],s.push([t.indexOf(match),match.length-1]);return{score:r?.5:1,isMatch:r,matchedIndices:s}}},function(t,e,i){"use strict";t.exports=function(t,e){var i=e.errors,n=void 0===i?0:i,r=e.currentLocation,s=void 0===r?0:r,a=e.expectedLocation,o=void 0===a?0:a,c=e.distance,l=void 0===c?100:c,u=n/t.length,h=Math.abs(o-s);return l?u+h/l:h?1:u}},function(t,e,i){"use strict";var n=i(6),r=i(3);t.exports=function(t,e,i,s){for(var a=s.location,o=void 0===a?0:a,c=s.distance,l=void 0===c?100:c,u=s.threshold,h=void 0===u?.6:u,d=s.findAllMatches,p=void 0!==d&&d,f=s.minMatchCharLength,v=void 0===f?1:f,g=o,m=t.length,y=h,_=t.indexOf(e,g),b=e.length,w=[],k=0;k<m;k+=1)w[k]=0;if(-1!=_){var S=n(e,{errors:0,currentLocation:_,expectedLocation:g,distance:l});if(y=Math.min(S,y),-1!=(_=t.lastIndexOf(e,g+b))){var x=n(e,{errors:0,currentLocation:_,expectedLocation:g,distance:l});y=Math.min(x,y)}}_=-1;for(var T=[],P=1,C=b+m,$=1<<b-1,A=0;A<b;A+=1){for(var I=0,L=C;I<L;)n(e,{
errors:A,currentLocation:g+L,expectedLocation:g,distance:l})<=y?I=L:C=L,L=Math.floor((C-I)/2+I);C=L;var E=Math.max(1,g-L+1),j=p?m:Math.min(g+L,m)+b,M=Array(j+2);M[j+1]=(1<<A)-1;for(var O=j;O>=E;O-=1){var F=O-1,R=i[t.charAt(F)];if(R&&(w[F]=1),M[O]=(M[O+1]<<1|1)&R,0!==A&&(M[O]|=(T[O+1]|T[O])<<1|1|T[O+1]),M[O]&$&&(P=n(e,{errors:A,currentLocation:F,expectedLocation:g,distance:l}))<=y){if(y=P,(_=F)<=g)break;E=Math.max(1,2*g-_)}}if(n(e,{errors:A+1,currentLocation:g,expectedLocation:g,distance:l})>y)break;T=M}return{isMatch:_>=0,score:0===P?.001:P,matchedIndices:r(w,v)}}},function(t,e,i){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),s=i(1),a=i(2),o=i(0),c=function(){function t(e,i){var r=i.location,s=void 0===r?0:r,o=i.distance,c=void 0===o?100:o,l=i.threshold,u=void 0===l?.6:l,h=i.maxPatternLength,d=void 0===h?32:h,p=i.caseSensitive,f=void 0!==p&&p,v=i.tokenSeparator,g=void 0===v?/ +/g:v,m=i.findAllMatches,y=void 0!==m&&m,_=i.minMatchCharLength,b=void 0===_?1:_,w=i.id,k=void 0===w?null:w,S=i.keys,x=void 0===S?[]:S,T=i.shouldSort,P=void 0===T||T,C=i.getFn,$=void 0===C?a:C,A=i.sortFn,I=void 0===A?function(t,e){return t.score-e.score}:A,L=i.tokenize,E=void 0!==L&&L,j=i.matchAllTokens,M=void 0!==j&&j,O=i.includeMatches,F=void 0!==O&&O,R=i.includeScore,U=void 0!==R&&R,D=i.verbose,N=void 0!==D&&D;n(this,t),this.options={location:s,distance:c,threshold:u,maxPatternLength:d,isCaseSensitive:f,tokenSeparator:g,findAllMatches:y,minMatchCharLength:b,id:k,keys:x,includeMatches:F,includeScore:U,shouldSort:P,getFn:$,sortFn:I,verbose:N,tokenize:E,matchAllTokens:M},this.set(e)}return r(t,[{key:"set",value:function(t){return this.list=t,t}},{key:"search",value:function(t){this._log('---------\nSearch pattern: "'+t+'"');var e=this._prepareSearchers(t),i=e.tokenSearchers,n=e.fullSearcher,r=this._search(i,n),s=r.weights,a=r.results;return this._computeScore(s,a),this.options.shouldSort&&this._sort(a),this._format(a)}},{key:"_prepareSearchers",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=[];if(this.options.tokenize)for(var i=t.split(this.options.tokenSeparator),n=0,r=i.length;n<r;n+=1)e.push(new s(i[n],this.options));return{tokenSearchers:e,fullSearcher:new s(t,this.options)}}},{key:"_search",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments[1],i=this.list,n={},r=[];if("string"==typeof i[0]){for(var s=0,a=i.length;s<a;s+=1)this._analyze({key:"",value:i[s],record:s,index:s},{resultMap:n,results:r,tokenSearchers:t,fullSearcher:e});return{weights:null,results:r}}for(var o={},c=0,l=i.length;c<l;c+=1)for(var u=i[c],h=0,d=this.options.keys.length;h<d;h+=1){var p=this.options.keys[h];if("string"!=typeof p){if(o[p.name]={weight:1-p.weight||1},p.weight<=0||p.weight>1)throw new Error("Key weight has to be > 0 and <= 1");p=p.name}else o[p]={weight:1};this._analyze({key:p,value:this.options.getFn(u,p),record:u,index:c},{resultMap:n,results:r,tokenSearchers:t,fullSearcher:e})}return{weights:o,results:r}}},{key:"_analyze",value:function(t,e){var i=t.key,n=t.value,r=t.record,s=t.index,a=e.tokenSearchers,c=void 0===a?[]:a,l=e.fullSearcher,u=void 0===l?[]:l,h=e.resultMap,d=void 0===h?{}:h,p=e.results,f=void 0===p?[]:p;if(void 0!==n&&null!==n){var v=!1,g=-1,m=0;if("string"==typeof n){this._log("\nKey: "+(""===i?"-":i));var y=u.search(n);if(this._log('Full text: "'+n+'", score: '+y.score),this.options.tokenize){for(var _=n.split(this.options.tokenSeparator),b=[],w=0;w<c.length;w+=1){var k=c[w];this._log('\nPattern: "'+k.pattern+'"');for(var S=!1,x=0;x<_.length;x+=1){var T=_[x],P=k.search(T),C={};P.isMatch?(C[T]=P.score,v=!0,S=!0,b.push(P.score)):(C[T]=1,this.options.matchAllTokens||b.push(1)),this._log('Token: "'+T+'", score: '+C[T])}S&&(m+=1)}g=b[0];for(var $=b.length,A=1;A<$;A+=1)g+=b[A];g/=$,this._log("Token score average:",g)}var I=y.score;g>-1&&(I=(I+g)/2),this._log("Score average:",I);var L=!this.options.tokenize||!this.options.matchAllTokens||m>=c.length;if(this._log("\nCheck Matches: "+L),(v||y.isMatch)&&L){var E=d[s];E?E.output.push({key:i,score:I,matchedIndices:y.matchedIndices}):(d[s]={item:r,output:[{key:i,score:I,matchedIndices:y.matchedIndices}]},f.push(d[s]))}}else if(o(n))for(var j=0,M=n.length;j<M;j+=1)this._analyze({key:i,value:n[j],record:r,index:s},{resultMap:d,results:f,tokenSearchers:c,fullSearcher:u})}}},{key:"_computeScore",value:function(t,e){this._log("\n\nComputing score:\n");for(var i=0,n=e.length;i<n;i+=1){for(var r=e[i].output,s=r.length,a=0,o=1,c=0;c<s;c+=1){var l=r[c].score,u=t?t[r[c].key].weight:1,h=l*u;1!==u?o=Math.min(o,h):(r[c].nScore=h,a+=h)}e[i].score=1===o?a/s:o,this._log(e[i])}}},{key:"_sort",value:function(t){this._log("\n\nSorting...."),t.sort(this.options.sortFn)}},{key:"_format",value:function(t){var e=[];this._log("\n\nOutput:\n\n",t);var i=[];this.options.includeMatches&&i.push(function(t,e){var i=t.output;e.matches=[];for(var n=0,r=i.length;n<r;n+=1){var s=i[n],a={indices:s.matchedIndices};s.key&&(a.key=s.key),e.matches.push(a)}}),this.options.includeScore&&i.push(function(t,e){e.score=t.score});for(var n=0,r=t.length;n<r;n+=1){var s=t[n];if(this.options.id&&(s.item=this.options.getFn(s.item,this.options.id)[0]),i.length){for(var a={item:s.item},o=0,c=i.length;o<c;o+=1)i[o](s,a);e.push(a)}else e.push(s.item)}return e}},{key:"_log",value:function(){if(this.options.verbose){var t;(t=console).log.apply(t,arguments)}}}]),t}();t.exports=c}])}),_.mixin({sortByNat:function(t,e,i){var n=_.isFunction(e)?e:function(t){return t[e]};return _.pluck(_.map(t,function(t,e,r){return{value:t,index:e,criteria:n.call(i,t,e,r)}}).sort(function(t,e){var i=t.criteria,n=e.criteria;return naturalSort(i,n)}),"value")}}),Backbone.Collection.prototype.sortByNat=function(t,e){var i=_.isFunction(t)?t:function(e){return e.get(t)};return _.sortByNat(this.models,i,e)},Backbone.Collection.prototype.sortNat=function(t){if(!this.comparator)throw new Error("Cannot sortNat a set without a comparator");return t||(t={}),_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortByNat(this.comparator,this):this.models.sortNat(_.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},Backbone.Collection.prototype._sort=Backbone.Collection.prototype.sort,Backbone.Collection.prototype.sort=function(){this.sortType&&"natural"===this.sortType?Backbone.Collection.prototype.sortNat.apply(this,arguments):Backbone.Collection.prototype._sort.apply(this,arguments)},Object.defineProperty(HTMLMediaElement.prototype,"playing",{get:function(){return!!(this.currentTime>0&&!this.paused&&!this.ended&&this.readyState>2)}}),function(t){t.fn.getInputSelection=function(){var t=this.get(0),e={start:0,end:0,text:""};if(t){if("selectionStart"in t)e.start=t.selectionStart,e.end=t.selectionEnd,e.text=t.value.substring(e.start,e.end);else if(document.selection){t.focus();var i=document.selection.createRange(),n=document.selection.createRange().text.length;i.moveStart("character",-t.value.length),e.start=i.text.length-n,e.end=e.start+n,e.text=i.text}return e}}}(jQuery),function(t){t.fn.setInputPosition=function(t){var e=this.get(0);if(e)if(e.focus(),"selectionStart"in e)e.setSelectionRange(t,t);else if(e.createTextRange){var i=e.createTextRange();i.move("character",t),i.select()}}}(jQuery),function(t){t.fn.getTextSize=function(){var e="text-width-tester",i=this.val(),n=t("#"+e),r={fontWeight:this.css("font-weight"),fontSize:this.css("font-size"),fontFamily:this.css("font-family"),display:"none"};return n.length?n.css(r).html(i):(n=t('<span id="'+e+'">'+i+"</span>"),n.css(r),t("body").append(n)),{width:n.width(),height:n.height()}}}(jQuery),function(){window.UTIL={},UTIL.escapeInput=function(t){return t.replace(/"/g,"&quot;")},UTIL.formatDate=function(t){var e=new Date(t);return e.getFullYear()+"-"+e.getMonth()+"-"+e.getDate()},UTIL.formatNumber=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},UTIL.formatNumberTiny=function(t,e){e||0===e||(e=1);var i=t;return t>1e6?i=UTIL.round(t/1e6,e)+"M+":1e6==t?i="1M":t>99999?i=UTIL.round(t/1e3)+"K+":t>1e3?i=UTIL.round(t/1e3,e)+"K+":1e3==t&&(i="1K"),i},UTIL.formatTime=function(t,e){var i,n=t||0,r=parseInt(Math.floor(n/3600))%24,s=parseInt(Math.floor(n/60))%60,n=UTIL.round(n%60,e);return i=(r>0?r+":":"")+(s<10?"0"+s:s)+":"+(n<10?"0"+n:n),"0"==i[0]&&(i=i.substring(1,i.length)),i},UTIL.formatTimeAlt=function(t){var e,i=t||0,n=parseInt(Math.floor(i/3600))%24,r=parseInt(Math.floor(i/60))%60,i=UTIL.round(i%60);return e=r>0?(n>0?n+"h ":"")+r+"m":i+"s"},UTIL.formatTimeMs=function(t,e){return UTIL.formatTime(.001*t,e)},UTIL.getSeconds=function(t,e){for(var i=t.split(":").reverse(),n=0,r=i.length-1;r>=0;r--)switch(r){case 2:n+=60*parseInt(i[r])*60;break;case 1:n+=60*parseInt(i[r]);break;case 0:n+=parseFloat(i[r])}return UTIL.round(n,e)},UTIL.highlightText=function(t,e,i,n){i=i||"<span>",n=n||"</span>";var r=new RegExp("("+t+")","ig");return e.replace(r,i+"$1"+n)},UTIL.makeId=function(t){for(var e="",i="abcdefghijklmnopqrstuvwxyz",n="abcdefghijklmnopqrstuvwxyz0123456789",t=t||8,r=0;r<t;r++)e+=r<=0?i.charAt(Math.floor(Math.random()*i.length)):n.charAt(Math.floor(Math.random()*n.length));return e},UTIL.randomNumber=function(t){return Math.floor(Math.pow(10,t-1)+9*Math.random()*Math.pow(10,t-1))},UTIL.round=function(t,e){return t=parseFloat(t),e=e||0,Math.round(t*Math.pow(10,e))/Math.pow(10,e)}}();var COMPONENTS=function(){function t(){this.init()}return t.prototype.init=function(){this.selectInit(),this.alertInit(),this.scrollInit(),this.stickyInit(),this.toggleInit(),this.toggleSoundInit()},t.prototype.alert=function(t,e,i,n){i=i||"#primary-alert",n=n||3e3;var r=$(i);r.html("<div>"+t+"</div>").addClass("active"),this.timeout&&clearTimeout(this.timeout),e&&(this.timeout=setTimeout(function(){r.removeClass("active")},n))},t.prototype.alertInit=function(){var t=this;$(window).on("alert",function(e,i,n,r,s){t.alert(i,n,r,s)}),$(".alert").on("click",function(){$(this).removeClass("active")})},t.prototype.scrollInit=function(){var t=this;$(window).on("scroll-to",function(e,i,n,r){t.scrollTo(i,n,r)})},t.prototype.scrollTo=function(t,e,i){e=e||0,i=i||2e3,$("html, body").animate({scrollTop:t.offset().top-e},2e3)},t.prototype.select=function(t){var e=t.closest(".select"),i=e.find(".select-active"),n=e.find(".select-option"),r=t.attr("data-active")||t.text();n.removeClass("selected").attr("aria-checked","false"),t.addClass("selected").attr("aria-checked","true"),i.text(r),e.removeClass("active")},t.prototype.selectInit=function(){var t=this;$(document).on("click",".select-active",function(){t.selectMenu($(this).closest(".select"))}),$(document).on("click",".select-option",function(){t.select($(this))}),$(document).on("click",function(e){$(e.target).closest(".select").length||t.selectMenusHide()})},t.prototype.selectMenu=function(t){t.addClass("active")},t.prototype.selectMenusHide=function(){$(".select").removeClass("active")},t.prototype.sticky=function(t){var e=$(".sticky-on-scroll");if(!e.length)return!1;var i=t?$(t).height():0,n=$(window).scrollTop();e.each(function(){var t=$(this),e=t.offset().top;n>e-i?$(t.attr("data-sticky")).addClass("sticky"):$(t.attr("data-sticky")).removeClass("sticky")})},t.prototype.stickyInit=function(){var t=this;$(window).on("sticky-on",function(e,i){t.stickyOn(i)})},t.prototype.stickyOn=function(t){if(this.sticky_is_on)return!1;this.sticky_is_on=!0;var e=this;$(window).on("scroll",function(){e.sticky(t)})},t.prototype.toggle=function(t){$(t).toggleClass("active")},t.prototype.toggleInit=function(){var t=this;$(document).on("click",".toggle-active",function(e){e.preventDefault(),t.toggle($(this).attr("data-target"))})},t.prototype.toggleSound=function(t){var e=t[0];e&&e.muted?e.muted=!1:e&&(e.muted=!0)},t.prototype.toggleSoundInit=function(){var t=this;$(document).on("click",".toggle-sound",function(e){e.preventDefault(),t.toggleSound($(this))})},t}();$(function(){new COMPONENTS}),function(){window.ANALYTICS={},ANALYTICS.event=function(t,e,i,n){"undefined"!=typeof ga&&(i&&n?ga("send","event",t,e,i,n):i?ga("send","event",t,e,i):ga("send","event",t,e))}}(),window.API_URL=PROJECT.apiUrl||window.location.protocol+"//"+window.location.hostname,window.location.port&&!PROJECT.apiUrl&&(window.API_URL+=":"+window.location.port),window.DEBUG=!0,window.app={models:{},collections:{},views:{},routers:{},initialize:function(){_.object(_.map(PROJECT.authProviders,function(t){return[t.name,t.path]}));PubSub.subscribe("auth.oAuthSignIn.success",function(t,e){window.location.reload(!0)}),PubSub.subscribe("auth.signOut.success",function(t,e){window.location.reload(!0)});var t=(new app.routers.DefaultRouter,!0),e=!!(t&&window.history&&window.history.pushState);Backbone.history=Backbone.history||new Backbone.History({}),Backbone.history.start({pushState:e})}},window.app.pageTitle=function(t){t||(t="");var e=document.getElementsByTagName("title");if(!e.length)return"";var i=e[0],n=i.getAttribute("data-title-sitename")?i.getAttribute("data-title-sitename"):i.textContent,r=i.getAttribute("data-title-template")?i.getAttribute("data-title-template"):"";return t.length&&r.length?r.replace("{{sitename}}",n).replace("{{pagename}}",t):i.textContent},$(function(){app.initialize()}),window.app.socialIntegration=function(){this.intervalStage1=null,this.intervalStage2=null,this.initialised=!1,this.attempts=0,this.maxAttempts=100,this.shown=!1;var t=function(t){return!!(t.twttr&&t.twttr.widgets&&t.twttr.widgets.load&&t.FB&&t.FB.XFBML&&t.FB.XFBML.parse)};this.showSocialWidgets=function(){window.twttr.widgets.load(),FB.XFBML.parse(),this.shown=!0},this.runIntervalStage2=function(){if(!this.shown){var e=t(window);return e?(clearInterval(this.socialLoadIntId),void this.showSocialWidgets()):(this.attempts++,this.attempts>=this.maxAttempts?(console.error("Gave up on loading social widgets."),void clearInterval(this.socialLoadIntId)):void 0)}},this.initFacebook=function(t,e,i,n){if(!document.getElementById("fb-root"))return!1;var r,s=t.getElementsByTagName(e)[0];if(!t.getElementById(i))return r=t.createElement(e),r.id=i,r.src="//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.8&appId="+n,s.parentNode.insertBefore(r,s),!0},this.initTwitter=function(t,e,i){var n,r=t.getElementsByTagName(e)[0],s=window.twttr||{};return t.getElementById(i)?s:(n=t.createElement(e),n.id=i,n.src="https://platform.twitter.com/widgets.js",r.parentNode.insertBefore(n,r),s._e=[],s.ready=function(t){s._e.push(t)},s)},this.initSocialScripts=function(){if(!document.getElementById("fb-root")){var t=document.getElementsByTagName("body")[0],e=document.createElement("div");e.setAttribute("id","fb-root"),t.insertBefore(e,t.firstChild)}"undefined"!=typeof facebookAppId&&(window.fbLoad=this.initFacebook(document,"script","facebook-jssdk",facebookAppId)),window.twttr=this.initTwitter(document,"script","twitter-wjs"),this.initialised=!!document.getElementById("fb-root")&&!!window.fbLoad&&!!window.twttr},this.completeStage1=function(){this.attempts=0,this.shown=!1,this.intervalStage2&&clearInterval(this.intervalStage2),this.intervalStage2=setInterval(this.runIntervalStage2.bind(this),250)},this.runIntervalStage1=function(){this.initialised?(clearInterval(this.intervalStage1),this.completeStage1()):this.initSocialScripts()},this.init=function(){this.intervalStage1&&clearInterval(this.intervalStage1),this.intervalStage1=setInterval(this.runIntervalStage1.bind(this),250)}},window.app.social=new window.app.socialIntegration,document.addEventListener("DOMContentLoaded",function(t){window.app.social.init()}),app.routers.DefaultRouter=Backbone.Router.extend({routes:{"":"index","?*queryString":"index","transcripts/:id":"transcriptEdit","transcripts/:id?*queryString":"transcriptEdit","page/:id":"pageShow",dashboard:"dashboard",search:"search","search?*queryString":"search",collections:"collections"},before:function(t,e){$("#main").empty().addClass("loading")},after:function(t,e){window.scrollTo(0,0)},dashboard:function(){var t=this._getData(t),e=(new app.views.Header(t),new app.views.Dashboard(t));new app.views.Footer(t);e.$el.attr("role","main")},index:function(t){var e=this._getData(e);t&&(e.queryParams=deparam(t));new app.views.Header(e),new app.views.Home(e),new app.views.Footer(e)},pageShow:function(t){var e=this._getData(e),i=(new app.views.Header(e),new app.views.Page(_.extend({},e,{el:"#main",page_key:t})));new app.views.Footer(e);i.$el.removeClass("loading").attr("role","main")},search:function(t){var e=this._getData(e);t&&(e.queryParams=deparam(t));new app.views.Header(e),new app.views.Search(e),new app.views.Footer(e)},collections:function(){var t=this._getData(t);new app.views.Header(t),new app.views.Collections(t),new app.views.Footer(t)},transcriptEdit:function(t,e){var i=this._getData(i);e&&(i.queryParams=deparam(e));var n=(new app.views.Header(i),new app.views.TranscriptToolbar(_.extend({},i,{el:"#secondary-navigation",menu:"transcript_edit"})),new app.views.Modals(i)),r=(new app.views.Footer(i),new app.views.TranscriptLineVerify(i));n.addModal(r.$el);var s=new app.views.TranscriptLineFlag(i);n.addModal(s.$el);var a=new app.views.TranscriptDownload(_.extend({},i,{transcript_id:t}));n.addModal(a.$el);var o=new app.models.Transcript({id:t});new app.views.TranscriptEdit(_.extend({},i,{el:"#main",model:o}))},_getData:function(t){var e={};return $.auth&&$.auth.user&&$.auth.user.signedIn&&(e=$.auth.user),t=t||{},t=$.extend({},{project:PROJECT,user:e,debug:DEBUG,route:this._getRouteData()},t),DEBUG&&console.log("Route",t.route),t},_getRouteData:function(){var t,e,i=this,n=Backbone.history.fragment,r=_.pairs(i.routes),s=null,a=null,o=null;return t=_.find(r,function(t){return a=_.isRegExp(t[0])?t[0]:i._routeToRegExp(t[0]),a.test(n)}),t&&(o=i._extractParameters(a,n),s=t[0],a=t[1]),e=n?"/#/"+n:"/",{route:s,action:a,fragment:n,path:e,params:o}}}),app.models.Transcript=Backbone.Model.extend({parse:function(t){return t},url:function(){var t=this.get("uid")||this.id;return API_URL+"/transcripts/"+t+".json"}}),app.collections.Collections=Backbone.Collection.extend({url:function(){return API_URL+"/collections.json"}}),app.collections.Transcripts=Backbone.Collection.extend({sortType:"natural",initialize:function(t){var e={endpoint:"/transcripts.json"};this.options=_.extend({},e,t),this.params={page:1},this.options.params&&(this.params=_.extend({},this.params,this.options.params))},getPage:function(){return this.params.page},getParam:function(t){return this.params[t]},getParams:function(){return this.params},hasAllPages:function(){return!this.hasMorePages()},hasMorePages:function(){return this.params.page*this.per_page<this.total},nextPage:function(){this.params.page+=1},parse:function(t){this.params.page=t.current_page,this.per_page=t.per_page,this.total=t.total_entries;var e=[];return _.each(t.entries,function(t,i){t.completeness=t.percent_completed+.01*t.percent_edited,e.push(t)}),e},setParams:function(t){var e=this;_.each(t,function(t,i){"ALL"!=t&&t.length?e.params[i]=t:e.params=_.omit(e.params,i)})},url:function(){var t="?"+$.param(this.params);return API_URL+this.options.endpoint+t}}),app.views.Base=Backbone.View.extend({}),app.views.Collections=app.views.Base.extend({el:"#main",template:_.template(TEMPLATES["collections_index.ejs"]),initialize:function(t){var e={queryParams:{}};this.data=_.extend({},e,t),this.render()},onCollectionsLoaded:function(t){var e=t.toJSON();this.$el.html(this.template({collections:e})),this.$el.removeClass("loading")},render:function(){return document.title=app.pageTitle("Collections"),this.collections=this.collections||new app.collections.Collections({endpoint:"/collections.json"}),this.collections.fetch({success:this.onCollectionsLoaded.bind(this),error:function(t,e,i){$(window).trigger("alert",["Whoops! We seem to have trouble loading our transcripts. Please try again by refreshing your browser or come back later!"])}}),this}}),app.views.Account=app.views.Base.extend({el:"#account-container",template:_.template(TEMPLATES["account.ejs"]),events:{"click .auth-link":"doAuthFromLink","click .check-auth-link":"checkAuthForLink","click .sign-out-link":"signOut"},initialize:function(t){this.data=t,this.data.signedIn=!1,this.data.score=0,this.loadListeners(),this.loadUser(),this.render()},loadUser:function(){var t=this;console.log("Logged in user"),$.post(API_URL+"/authenticate.json",function(e){user=e.user,user.id?(t.data.signedIn=!0,t.data.user=user,t.data.score=user.lines_edited,PubSub.publish("auth.validation.success",user)):(t.data.signedIn=!1,t.data.user=null,t.data.score=null)})},doAuth:function(t){$.auth.oAuthSignIn({provider:t}).fail(function(t){$(window).trigger("alert",["Authentication failure: "+t.errors.join(" ")])})},doAuthFromLink:function(t){t.preventDefault();var e=$(t.currentTarget).attr("data-provider");this.doAuth(e)},checkAuthForLink:function(t){t.preventDefault(),$.auth.validateToken().then(function(e){console.log("checkAuthForLink success"),window.location.href=t.target.href}).fail(function(){console.log("checkAuthForLink failure"),$(window).trigger("alert",["You must log in as admin to access this section.",!0])})},listenForAuth:function(){var t=this;PubSub.subscribe("auth.oAuthSignIn.success",function(e,i){t.onValidationSuccess($.auth.user),$(window).trigger("alert",["Successfully signed in as "+$.auth.user.name+"!  Refreshing page...",!0])}),PubSub.subscribe("auth.validation.success",function(e,i){t.onValidationSuccess(i)}),PubSub.subscribe("auth.signOut.success",function(e,i){t.onSignOutSuccess(),$(window).trigger("alert",["Successfully signed out! Refreshing page...",!0])})},loadListeners:function(){var t=this;this.listenForAuth(),PubSub.subscribe("transcript.edit.submit",function(e,i){i.is_new&&t.data.user.signedIn&&(t.data.score+=1,t.updateScore())})},onSignOutSuccess:function(){this.data.user={},this.data.score=0,window.history.pushState({},document.title,"/")},onValidationSuccess:function(t){this.data.user=t,this.data.score=t.lines_edited,this.render()},render:function(){return this.$el.html(this.template(this.data)),this},signOut:function(t){t&&t.preventDefault(),$.auth.signOut()},updateScore:function(){this.$(".score").text(UTIL.formatNumberTiny(this.data.score)).addClass("active")}}),app.views.Crumbs=app.views.Base.extend({template:_.template(TEMPLATES["crumbs.ejs"]),initialize:function(t){this.data=t,this.data.crumbs=this.data.crumbs||[],this.listenForCrumbs(),this.render()},listenForCrumbs:function(){var t=this;PubSub.subscribe("transcript.load",function(e,i){var n={label:i.label||i.transcript.title};t.data.crumbs=[n],t.render()})},render:function(){return this.$el.html(this.template(this.data)),this}}),app.views.Menu=app.views.Base.extend({template:_.template(TEMPLATES["menu.ejs"]),initialize:function(t){this.data=t,this.data.menu_key=this.data.menu_key||"";var e=this.data.project.menus||{},i=this.data.menu_key;this.data.menu=[],i&&e[i]&&(this.data.menu=e[i]),this.render()},render:function(){return this.$el.html(this.toString()),this},toString:function(){return this.template(this.data)}}),app.views.Modal=app.views.Base.extend({tagName:"div",className:"modal-wrapper",template:_.template(TEMPLATES["modal.ejs"]),events:{"click .modal-tab":"tab"},initialize:function(t){this.data=_.extend({},t),this.data.active_page=0,this.data.active=!1,this.loadContents(),this.render()},loadContents:function(){var t=this,e=this.data.page?[this.data.page]:this.data.pages;_.each(e,function(i,n){var r=new app.views.Page(_.extend({},t.data,{page_key:i.file}));e[n].contents=r.toString()}),this.data.pages=e},render:function(){return this.$el.html(this.template(this.data)),this},tab:function(t){t&&t.preventDefault();var e=$(t.currentTarget);this.data.active_page=parseInt(e.attr("data-tab")),this.data.active=!0,this.render()}}),app.views.Page=app.views.Base.extend({template:_.template(TEMPLATES["page.ejs"]),initialize:function(t){this.data=_.extend({},t),this.data.content=this.data.content||"",this.getPageContent(),this.el&&this.render(),this.displayQueryStringAlert()},getPageContent:function(){var t=this.data.page_key,e=this.data.project.pages;if(!t)return!1;if(e[t]||(t+=".md"),e[t]){var i=_.template(e[t]);this.data.content=i(this.data)}},getPageTitle:function(){if(this.data.page_key){var t=this.data.content.match(/<h1.*>([^<]+)<\/h1>/);if(t)return t[1]}return""},render:function(){this.$el.html(this.toString());var t=this.getPageTitle();return t.length&&(document.title=app.pageTitle(t)),this},toString:function(){return this.template(this.data)},displayQueryStringAlert:function(){if(window.location.search&&window.location.search.length){var t=window.location.search.match(/show_alert=([^&]+)/);if(t){$(window).trigger("alert",[decodeURIComponent(t[1]).replace(/\+/g," "),!0]);var e=window.location.href.replace("show_alert="+t[1]).replace(/(&+)/,"&").replace(/(\?&)/,"?");window.history.pushState({},document.title,e)}}}}),app.views.Dashboard=app.views.Base.extend({template:_.template(TEMPLATES["user_dashboard.ejs"]),el:"#main",initialize:function(t){this.data=t,this.secondsPerLine=5,this.listenForAuth()},listenForAuth:function(){var t=this;PubSub.subscribe("auth.validation.success",function(e,i){t.loadData(i)})},loadData:function(t){var e=this;this.data.transcripts=[],$.getJSON("/transcript_edits.json",{user_id:t.id},function(t){t.edits&&t.edits.length&&e.parseEdits(t.edits,t.transcripts),e.render()})},parseEdits:function(t,e){var i=this;t=_.map(t,function(t){var e=_.clone(t);return e.updated_at=Date.parse(e.updated_at)/1e3,e});var e=_.map(e,function(e,n){var r=_.clone(e);r.index=n,r.edits=_.filter(t,function(t){return t.transcript_id==e.id}),r.edit_count=r.edits.length,r.seconds_edited=r.edit_count*i.secondsPerLine;var s=_.max(r.edits,function(t){return t.updated_at});return s&&(r.updated_at=s.updated_at),r});this.data.transcripts=_.sortBy(e,function(t){return t.updated_at}).reverse(),this.data.edit_count=t.length,this.data.seconds_edited=this.data.edit_count*this.secondsPerLine},render:function(){return this.$el.html(this.template(this.data)),this.$el.removeClass("loading"),this}}),app.views.Footer=app.views.Base.extend({el:"#footer",initialize:function(t){this.data=_.extend({},t),this.render()},render:function(){return this.renderContent(),this.renderMenu(),this},renderContent:function(){if(this.data.project.pages["footer.md"]){var t=new app.views.Page(_.extend({},this.data,{page_key:"footer.md"}));this.$el.append(t.render().$el)}},renderMenu:function(){new app.views.Menu(_.extend({},this.data,{el:"#footer-menu-container",menu_key:"footer"}))}}),app.views.Header=app.views.Base.extend({el:"#header",title_template:_.template(TEMPLATES["header_title.ejs"]),initialize:function(t){this.data=t,this.render()},render:function(){this.renderTitle();new app.views.Crumbs(_.extend({},this.data,{el:"#header-crumbs"})),new app.views.Menu(_.extend({},this.data,{el:"#primary-menu-container",menu_key:"header"})),new app.views.Account(this.data);return this},renderTitle:function(){this.$el.find("#header-title").html(this.title_template(this.data))}}),app.views.Home=app.views.Base.extend({el:"#main",initialize:function(t){this.data=t,this.render()},render:function(){var t=new app.views.Page(_.extend({},this.data,{page_key:"home.md"})),e=new app.collections.Transcripts,i=new app.collections.Collections,n=new app.views.TranscriptsIndex(_.extend({},this.data,{collection:e,collections:i}));return this.$el.append(t.render().$el),this.$el.append(n.$el),this.$el.removeClass("loading"),this}}),app.views.Modals=app.views.Base.extend({el:"#app",events:{"click .modal-dismiss":"dismissModals","click .modal-invoke":"invokeModalFromLink"},initialize:function(t){this.data=t,this.lastInvoked=!1,this.loadListeners(),this.render()},addModal:function(t){this.$el.append(t)},dismissModals:function(t){t&&t.preventDefault(),this.$(".modal").removeClass("active")},invokeModal:function(t){this.$("#"+t).find(".modal").addClass("active"),this.lastInvoked=t},invokeModalFromLink:function(t){t.preventDefault(),this.invokeModal($(t.currentTarget).attr("data-modal"))},loadListeners:function(){var t=this;PubSub.subscribe("modal.invoke",function(e,i){t.invokeModal(i)}),PubSub.subscribe("modals.dismiss",function(e,i){t.dismissModals()}),PubSub.subscribe("player.state.change",function(e,i){t.$el.attr("state",i)})},render:function(){if(this.$(".modal").length)return this;var t=this;this.data.project.pages;return _.each(this.data.project.modals,function(e,i){var n=_.extend({},e,{id:i,project:t.data.project}),e=new app.views.Modal(n);t.$el.append(e.$el)}),this}}),app.views.Search=app.views.Base.extend({el:"#main",template:_.template(TEMPLATES["transcript_search.ejs"]),template_list:_.template(TEMPLATES["transcript_list.ejs"]),template_item:_.template(TEMPLATES["transcript_search_item.ejs"]),events:{"submit .search-form":"searchFromForm","keyup .search-form input":"searchFromInput"},initialize:function(t){var e={queryParams:{}};this.data=_.extend({},e,t),this.render(),this.loadListeners(),this.loadTranscripts(),this.loadCollections()},loadCollections:function(){var t=this;this.collections=this.collections||new app.collections.Collections,this.collections.fetch({success:function(e,i,n){t.renderFacets(e.toJSON())},error:function(e,i,n){t.renderFacets([])}})},loadListeners:function(){var t=this;PubSub.subscribe("transcripts.filter",function(e,i){var n={};n[i.name]=i.value,t.setParams(n)}),PubSub.subscribe("transcripts.sort",function(e,i){t.setParams({sort_by:i.name,order:i.order})}),PubSub.subscribe("transcripts.search",function(e,i){t.setParams({q:i})})},loadTranscripts:function(){var t=this,e=this.data.queryParams;e.deep=1,this.$transcripts.addClass("loading"),this.transcripts=this.transcripts||new app.collections.Transcripts({endpoint:"/search.json",params:e}),this.transcripts.fetch({success:function(e,i,n){t.renderTranscripts(e)},error:function(t,e,i){$(window).trigger("alert",["Whoops! We seem to have trouble loading our transcripts. Please try again by refreshing your browser or come back later!"])}})},render:function(){return this.$el.html(this.template(this.data)),this.$el.removeClass("loading"),this.$transcripts=this.$("#transcript-results"),this.$facets=this.$("#transcript-facets"),document.title=app.pageTitle("Search"),this},renderFacets:function(t){this.facetsView=this.facetsView||new app.views.TranscriptFacets({collections:t,queryParams:this.data.queryParams,disableSearch:!0,disableSort:!0}),this.$facets.html(this.facetsView.render().$el)},renderTranscripts:function(t){var e=this,i=t.toJSON(),n=this.template_list({has_more:t.hasMorePages()}),r=$(n),s=r.first(),a=t.getParam("q")||"";t.getPage()>1?this.$transcripts.append(r):(this.$transcripts.empty(),i.length?this.$transcripts.html(r):this.$transcripts.html("<p>No transcripts found!</p>")),this.$transcripts.removeClass("loading"),_.each(i,function(t){var i=e.template_item(_.extend({},t,{query:a}));s.append($(i))}),$(window).trigger("scroll-to",[this.$("#search-form"),110])},search:function(t){PubSub.publish("transcripts.search",t)},searchFromForm:function(t){t.preventDefault();var e=$(t.currentTarget),i=e.find('input[name="keyword"]').val();i=i.trim().toLowerCase(),this.search(i)},searchFromInput:function(t){var e=$(t.currentTarget),i=e.val();i=i.trim(),i.length||this.search(i)},setParams:function(t){this.$transcripts.empty().addClass("loading"),t.page=1,this.transcripts.setParams(t),this.loadTranscripts(),this.updateUrlParams()},updateUrlParams:function(){var t=this.transcripts.getParams();if(_.keys(t).length>0&&window.history){var e="/"+this.data.route.route+"?"+$.param(t);window.history.pushState(t,document.title,e)}else if(window.history){var e="/"+this.data.route.route;window.history.pushState(t,document.title,e);
}}}),app.views.Transcript=app.views.Base.extend({current_line_i:-1,play_all:!1,centerOn:function(t){var e,i=t.offset().top,n=t.height(),r=$(window).height(),s=500,a=100,o=9999,c=+new Date;this.lastCenterActionTime&&(o=c-this.lastCenterActionTime),this.lastCenterActionTime=c,e=n<r?i-(r/2-n/2):i,o<s+a?$("html, body").scrollTop(e):$("html, body").animate({scrollTop:e},s)},checkForStartTime:function(){if(!this.data.queryParams||!this.data.queryParams.t)return!1;var t=UTIL.getSeconds(this.data.queryParams.t);if(!t)return!1;var e=0;_.each(this.data.transcript.lines,function(i,n){var r=UTIL.getSeconds(UTIL.formatTime(i.start_time/1e3));r<=t&&(e=n)}),this.lineSelect(e)},fitInput:function(t){var e=parseInt(t.css("font-size")),i=t.width()+5;t.attr("original-font-size")||t.attr("original-font-size",e);var n=t.getTextSize().width;n>i&&(e=e*i/n*.8),t.css({fontSize:e+"px"})},fitInputReset:function(t){t.attr("original-font-size")&&t.css({fontSize:t.attr("original-font-size")+"px"})},getPageTitle:function(){return this.data.transcript?this.data.transcript.title:""},lineNext:function(){this.lineSelect(this.current_line_i+1)},linePrevious:function(){this.lineSelect(this.current_line_i-1)},lineSave:function(t){},lineSelect:function(t){var e=this.data.transcript.lines;if(t>=e.length)return this.onLineOff(this.current_line_i),PubSub.publish("transcript.finished",!0),!1;if(t<0||t==this.current_line_i)return!1;this.onLineOff(this.current_line_i),this.current_line_i=t,this.current_line=this.data.transcript.lines[t];var i=$('.line[sequence="'+t+'"]').first(),n=i.find("input");$(".line.active").removeClass("active"),i.addClass("active"),this.centerOn(i),this.play_all||n.length&&n.first().focus(),this.fitInput(n);var r=this.$(".mobile-toggle.play"),s=this.$(".mobile-toggle.pause");s.hasClass("hidden")&&(r.addClass("hidden"),s.removeClass("hidden")),this.pause_at_time=.001*this.current_line.end_time,this.playerPlay(this.current_line.start_time)},lineSubmit:function(){this.lineNext()},lineToggle:function(){this.current_line_i<0?this.lineSelect(0):void 0!==this.pause_at_time&&this.player.currentTime>=this.pause_at_time&&!this.player.playing?this.playerPlay(this.current_line.start_time):this.playerToggle()},listenForAuth:function(){var t=this;PubSub.subscribe("auth.oAuthSignIn.success",function(e,i){t.refresh()}),PubSub.subscribe("auth.signOut.success",function(e,i){t.refresh()})},loadAudio:function(){if(this.player){if($(this.player).attr("data-transcript")==""+this.data.transcript.id)return this.onAudioLoad(),!1;$(this.player).remove()}var t=this,e=this.data.project.useVendorAudio&&this.data.transcript.vendor_audio_urls.length?this.data.transcript.vendor_audio_urls:[this.data.transcript.audio_url],i='<audio data-transcript="'+this.data.transcript.id+'" preload>';_.each(e,function(t){var e=t.substr(t.lastIndexOf(".")+1),n=e;"mp3"!=e&&"m4a"!=e||(n="mpeg"),i+='<source src="'+t+'" type="audio/'+n+'">'}),i+="</audio>";var n=$(i);this.player=n[0],this.player.onloadstart=function(){t.player_loaded||(t.player_loaded=!0,t.onAudioLoad())},this.player.ontimeupdate=function(){t.onTimeUpdate()},this.player.onwaiting=function(){t.message("Buffering audio..."),t.playerState("buffering")}},loadListeners:function(){},loadTranscript:function(){var t=this;this.$el.addClass("loading"),this.model.fetch({success:function(e,i,n){t.onTranscriptLoad(e)},error:function(t,e,i){$(window).trigger("alert",["Whoops! We seem to have trouble loading this transcript. Please try again by refreshing your browser or come back later!"])}})},loadUserProgress:function(){},message:function(t){},messageHide:function(t){},onAudioLoad:function(){},onLineOff:function(t){PubSub.publish("modals.dismiss",!0),this.lineSave(t);var e=$('.line[sequence="'+t+'"] input').first();this.fitInputReset(e)},onTranscriptLoad:function(t){},onTimeUpdate:function(){},parseTranscript:function(){var t=this,e=this.data.transcript.lines,i=this.data.transcript.user_edits,n=this.data.transcript.transcript_line_statuses,r=this.data.transcript.speakers||[],s=PROJECT.consensus.superUserHiearchy,a=this.data.transcript.user_role,o=this.data.transcript.user_flags,c=PROJECT.maxLineTimeOverlapMs,l=PROJECT.allowTranscriptDownload,u=_.object(_.map(i,function(t){return[""+t.transcript_line_id,t.text]})),h=_.object(_.map(n,function(t){return[""+t.id,t]})),d=_.map(r,_.clone);r.length>1&&d.push({id:-1,name:"Multiple Speakers"}),this.data.transcript.speaker_options=d;var p=_.object(_.map(d,function(t){return[""+t.id,t]})),f=_.pluck(d,"id"),v=_.object(_.map(o,function(t){return[""+t.transcript_line_id,t]}));this.data.transcript.can_download=l&&this.data.transcript.can_download,_.each(e,function(e,i){var o="";_.has(u,""+e.id)&&(o=u[""+e.id]),t.data.transcript.lines[i].user_text=o;var l=n[0];_.has(h,""+e.transcript_line_status_id)&&(l=h[""+e.transcript_line_status_id]),t.data.transcript.lines[i].status=l;var d=e.original_text;e.text&&"completed"==l.name?d=e.text:o?d=o:"guess"==PROJECT.consensus.lineDisplayMethod&&e.guess_text&&(d=e.guess_text),t.data.transcript.lines[i].display_text=d;var g=!0;_.contains(["reviewing","completed","flagged","archived"],l.name)&&(g=!1),"reviewing"==l.name&&o&&(g=!0),a&&a.hiearchy>=s&&(g=!0),t.data.transcript.lines[i].is_editable=g;var m=!0;_.contains(["completed","archived"],l.name)&&(m=!1),t.data.transcript.lines[i].is_available=m;var y=!1,b=-1;_.has(p,""+e.speaker_id)&&(y=p[""+e.speaker_id],b=f.indexOf(y.id)),t.data.transcript.lines[i].speaker=y,t.data.transcript.lines[i].speaker_pos=b,t.data.transcript.lines[i].has_speakers=r.length>1;var w={flag_type_id:0,text:""};_.has(v,""+e.id)&&(w=v[""+e.id]),t.data.transcript.lines[i].user_flag=w;var k=!1;if(a&&a.hiearchy>=s&&(k=!0),t.data.transcript.lines[i].can_resolve=k,c>=0&&i>0){var S=t.data.transcript.lines[i-1],x=S.end_time-e.start_time;if(x>c){var T=0;t.data.transcript.lines[i-1].end_time=t.data.transcript.lines[i].start_time+T,t.data.transcript.lines[i].start_time=t.data.transcript.lines[i].start_time-T}}}),this.data.transcript.percent_reviewing>0&&(this.data.transcript.hasLinesInReview=!0),this.data.transcript.percent_completed>0&&(this.data.transcript.hasLinesCompleted=!0)},playerPause:function(t){void 0===t&&(t={}),this.player.playing&&(this.player.pause(),this.message("Paused"),this.playerState("paused"),this.play_all&&"end_of_line"==t.trigger&&this.lineNext())},playerPlay:function(t){void 0!==t&&(this.player.currentTime=.001*t),this.player.playing||this.player.play()},playerState:function(t){return this.state!=t&&(this.state=t,this.$el.attr("state",t),void PubSub.publish("player.state.change",t))},playerToggle:function(){this.player.playing?this.playerPause({trigger:"manual"}):this.playerPlay()},refresh:function(){this.current_line_i=-1,this.loadTranscript()},render:function(){this.$el.html(this.template(this.data)),this.renderLines(),this.loadUserProgress();var t=this.getPageTitle();t.length&&(document.title=app.pageTitle(t))},renderLines:function(){var t=this.$el.find("#transcript-lines"),e=$("<div>");if(!t.length)return!1;t.empty();var i=this.data.transcript.speaker_options,n=this.data.transcript.id,r=this.data.transcript.flag_types;_.each(this.data.transcript.lines,function(t){var s=new app.views.TranscriptLine({transcript_id:n,line:t,speakers:i,flag_types:r});e.append(s.$el)}),t.append(e)},mobileToggle:function(){var t=this.$(".mobile-toggle.play"),e=this.$(".mobile-toggle.pause");e.hasClass("hidden")?(this.play_all=!0,this.current_line_i<0?this.lineSelect(0):this.playerPlay(),t.addClass("hidden"),e.removeClass("hidden")):(this.playerPause({trigger:"manual"}),e.addClass("hidden"),t.removeClass("hidden"))},start:function(){this.$(".start-play, .play-all").addClass("disabled");var t=0,e=this.data.transcript.lines;$.each(e,function(e,i){if(i.is_editable)return t=e,!1}),this.play_all&&(t=0),this.lineSelect(t)},playAll:function(){this.play_all=!0,this.start()},submitEdit:function(t){var e=this;this.message("Saving changes..."),$.post(API_URL+"/transcript_edits.json",{transcript_edit:t},function(t){e.message("Changes saved.")}),PubSub.publish("transcript.edit.submit",t)}}),app.views.TranscriptDownload=app.views.Base.extend({id:"transcript-download",className:"modal-wrapper",template:_.template(TEMPLATES["transcript_download.ejs"]),events:{"click .download":"download","submit .download-form":"download","change .formatOption":"selectFormat","change .format-options input":"updateURL"},initialize:function(t){var e=this;this.data=_.extend({},t),this.data.active=!1,this.data.transcript=!1,this.base_url=API_URL+"/transcript_files/"+this.data.transcript_id,PubSub.subscribe("transcript.load",function(t,i){e.onTranscriptLoad(i.transcript)})},download:function(t){t&&t.preventDefault();var e=this.$("#transcript-download-url").val();window.open(e)},onTranscriptLoad:function(t){this.data.transcript=t,this.render(),this.updateURL()},render:function(){this.$el.html(this.template(this.data))},selectFormat:function(t){var e=$(t.currentTarget),i=e.val();this.$(".format-options").removeClass("active"),this.$('.format-options[data-format="'+i+'"]').addClass("active"),this.updateURL()},updateURL:function(t){var e=this.$('input:radio[name="format"]:checked').val(),i=this.$(".format-options.active input").serialize(),n=this.base_url+"."+e;i.length&&(n+="?"+i),this.$("#transcript-download-url").val(n)}}),app.views.TranscriptFacets=app.views.Base.extend({template:_.template(TEMPLATES["transcript_facets.ejs"]),events:{"click .filter-by":"filterFromEl","click .sort-by":"sortFromEl","submit .search-form":"searchFromForm","keyup .search-form input":"searchFromInput"},initialize:function(t){this.data=_.extend({disableSearch:!1,disableSort:!1},t),this.initFacets(),$(window).trigger("sticky-on",["#header"])},filter:function(t,e){PubSub.publish("transcripts.filter",{name:t,value:e})},filterFromEl:function(t){var e=$(t.currentTarget);this.filter(e.attr("data-filter"),e.attr("data-value"))},initFacets:function(){var t=Amplify.getConfig("homepage.search.sort_options.active_collection_id","ALL"),e=Amplify.getConfig("homepage.search.sort_options.active_sort","id"),i=Amplify.getConfig("homepage.search.sort_options.active_order","asc"),n=Amplify.getConfig("homepage.search.sort_options.active_keyword","");if(this.data.queryParams){var r=this.data.queryParams;r.sort_by&&(e=r.sort_by),r.order&&(i=r.order),r.collection_id&&(t=r.collection_id),r.keyword&&(n=r.keyword)}if(this.data.collections.length){var s={id:"ALL",title:"All Collections"};this.data.collections.unshift(s),this.data.collections=_.map(this.data.collections,function(e){return e.active=!1,e.id==t&&(e.active=!0),e}),this.data.active_collection=_.findWhere(this.data.collections,{active:!0})}this.data.sort_options=[{id:"random_asc",name:"random",order:"asc",label:"Random"},{id:"title_asc",name:"title",order:"asc",label:"Title (A to Z)"},{id:"title_desc",name:"title",order:"desc",label:"Title (Z to A)"},{id:"completeness_desc",name:"completeness",order:"desc",label:"Completeness (most to least)"},{id:"completeness_asc",name:"completeness",order:"asc",label:"Completeness (least to most)"},{id:"duration_asc",name:"duration",order:"asc",label:"Duration (short to long)"},{id:"duration_desc",name:"duration",order:"desc",label:"Duration (long to short)"},{id:"collection_asc",name:"collection_id",order:"asc",label:"Collection"}],this.data.sort_options=_.map(this.data.sort_options,function(t){return t.active=!1,t.name==e&&t.order==i&&(t.active=!0),t}),this.data.active_sort=_.findWhere(this.data.sort_options,{active:!0}),this.data.active_keyword=n},render:function(){return this.$el.html(this.template(this.sanitiseRenderData(this.data))),this},sanitiseRenderData:function(t){return t.collections=t.collections.map(function(t){return t.hasOwnProperty("description")&&(t.description=t.description.replace(/<[^>]+>/g,"")),t}),t},search:function(t){PubSub.publish("transcripts.search",t)},searchFromForm:function(t){t.preventDefault();var e=$(t.currentTarget),i=e.find('input[name="keyword"]').val();i=i.trim().toLowerCase(),this.search(i)},searchFromInput:function(t){var e=$(t.currentTarget),i=e.val();i=i.trim(),i.length||this.search(i)},sortTranscripts:function(t,e){PubSub.publish("transcripts.sort",{name:t,order:e})},sortFromEl:function(t){var e=$(t.currentTarget);this.sortTranscripts(e.attr("data-sort"),e.attr("data-order"))}}),app.views.TranscriptLineFlag=app.views.Base.extend({id:"transcript-line-flag",className:"modal-wrapper",template:_.template(TEMPLATES["transcript_line_flag.ejs"]),events:{"click .option":"select","click .submit":"submit","click .toggle-play":"togglePlay","click .view-flags":"viewFlags","click .view-add-flag":"viewForm"},initialize:function(t){var e=this;this.lines={},this.data=_.extend({},t),this.data.title=this.data.title||"Flag this transcript line",this.data.active=this.data.active||!1,PubSub.subscribe("transcript.flags.load",function(t,i){e.onLoad(i)})},onLoad:function(t){if(!this.lines[t.line.id]){var e=_.extend({},t.line);this.lines[t.line.id]=e}this.data.transcript_id=t.transcript_id,this.data.flags=t.flags,this.data.flag_types=t.flag_types,this.data.line=this.lines[t.line.id],this.show()},render:function(){this.$el.html(this.template(this.data))},select:function(t){t.preventDefault();var e=this.$(".option"),i=$(t.currentTarget),n=parseInt(i.attr("type-id"));e.not('[type-id="'+n+'"]').removeClass("active").attr("aria-checked","false"),i.toggleClass("active");var r=0;i.hasClass("active")&&(i.attr("aria-checked","true"),r=n),this.data.line.user_flag.flag_type_id=r},show:function(){this.render(),PubSub.publish("transcript.play_all",!1),PubSub.publish("modal.invoke",this.id)},submit:function(t){t&&t.preventDefault();var e=this;this.data.line.user_flag.text=this.$(".input-text").val(),this.lines[this.data.line.id]=_.extend({},this.data.line);var i={flag_type_id:this.data.line.user_flag.flag_type_id,text:this.data.line.user_flag.text,transcript_line_id:this.data.line.id,transcript_id:this.data.transcript_id};return 0==i.flag_type_id?void e.$(".message").addClass("active").html("<p>Please select one of the above options to submit your flag.</p>"):void $.post(API_URL+"/flags.json",{flag:i},function(t){e.$(".message").addClass("active").html("<p>Thank you for flagging this line. We will be periodically reviewing and correcting flagged errors.</p>"),setTimeout(function(){PubSub.publish("modals.dismiss",!0)},3e3)})},togglePlay:function(t){t&&t.preventDefault(),PubSub.publish("player.toggle-play",!0)},viewFlags:function(t){t&&t.preventDefault(),this.$("footer .button, .flag-content").removeClass("active"),this.$(".view-add-flag, #flag-index").addClass("active")},viewForm:function(t){t&&t.preventDefault(),this.$("footer .button, .flag-content").removeClass("active"),this.$(".submit, .view-flags, #flag-add").addClass("active")}}),app.views.TranscriptItem=app.views.Base.extend({template:_.template(TEMPLATES["transcript_item.ejs"]),tagName:"a",className:"transcript-item",audioDelay:500,events:{"mouseover .item-image":"on","mouseout .item-image":"off"},initialize:function(t){this.data=_.extend({},t),this.transcript=this.data.transcript,this.timeout=!1,this.player=!1,this.player_enabled=PROJECT.previewAudioOnHover,this.render(),this.loadListeners()},audioInit:function(t){var e=this,i="<audio preload>";_.each(t,function(t){var e=t.substr(t.lastIndexOf(".")+1),n=e;"mp3"!=e&&"m4a"!=e||(n="mpeg"),i+='<source src="'+t+'" type="audio/'+n+'">'}),i+="</audio>";var n=$(i);this.$el.append(n),this.player=n[0],this.player.onwaiting=function(){e.$el.addClass("buffering")},this.player.ontimeupdate=function(){e.$el.removeClass("buffering"),e.queue_pause&&e.audioPause()}},audioPause:function(){this.player&&this.player.pause()},audioPlay:function(){return!!this.transcript.audio_urls.length&&(PubSub.publish("player.playing",this.transcript.id),this.player||this.audioInit(this.transcript.audio_urls),void(this.player.playing||this.queue_pause||this.player.play()))},loadListeners:function(){var t=this;PubSub.subscribe("player.playing",function(e,i){t.transcript.id!=i&&t.off()})},off:function(t){return!!this.player_enabled&&(this.queue_pause=!0,this.timeout&&clearTimeout(this.timeout),void this.audioPause())},on:function(t){if(!this.player_enabled)return!1;this.queue_pause=!1;var e=this;this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){e.audioPlay()},this.audioDelay)},render:function(){var t=this.transcript,e=t.title;return t.collection_title&&(e=t.collection_title+": "+e),this.$el.attr("title",e),this.$el.attr("role","listitem"),this.$el.attr("href",t.path),this.$el.html(this.template(t)),this}}),app.views.TranscriptLine=app.views.Base.extend({template:_.template(TEMPLATES["transcript_line.ejs"]),events:{click:"select","click .star":"star","click .flag":"flag","click .resolve":"resolve","click .verify":"verify","click .speaker-option":"selectSpeaker"},initialize:function(t){this.data=_.extend({},t),this.line=this.data.line||{},this.edits=this.data.edits||[],this.speakers=this.data.speakers||[],this.flag_types=this.data.flag_types||[],this.flags=this.data.flags||[],this.flagsLoaded=!1,this.render()},flag:function(t){t&&(t.preventDefault(),$(t.currentTarget).addClass("active"));var e=this;return this.select(),this.flagsLoaded?void PubSub.publish("transcript.flags.load",{flags:this.flags,line:this.line,flag_types:this.flag_types,transcript_id:this.data.transcript_id}):(this.flagsLoaded=!0,this.loadFlags(function(){e.flag()}),!1)},loadEdits:function(t){var e=this;$.getJSON(API_URL+"/transcript_edits.json",{transcript_line_id:this.line.id},function(i){i.edits&&i.edits.length&&(e.edits=e.parseEdits(i.edits),t&&t())})},loadFlags:function(t){var e=this;$.getJSON(API_URL+"/flags.json",{transcript_line_id:this.line.id},function(i){e.flags=i.flags||[],t&&t()})},parseEdits:function(t){var e=this.line,i=[],n=[];return _.each(t,function(t,r){_.contains(n,t.text)||(e.user_text==t.text&&(t.active=!0),n.push(t.text),i.push(t))}),i},render:function(){this.$el.html(this.template(_.extend({},this.line,{speakers:this.speakers})))},resolve:function(t){t&&(t.preventDefault(),$(t.currentTarget).addClass("active")),$.post(API_URL+"/transcript_lines/"+this.line.id+"/resolve.json"),this.$(".button.flag").removeClass("active")},select:function(t){t&&t.preventDefault(),PubSub.publish("transcript.line.select",this.line),!t||$(t.currentTarget).hasClass("verify")||"reviewing"!=this.line.status.name||this.line.is_editable||this.verify()},selectSpeaker:function(t){t.preventDefault();var e=$(t.currentTarget),i=parseInt(e.attr("data-id")),n=this.line.speaker_id;if(this.$(".speaker-option").removeClass("selected").attr("aria-checked","false"),this.$(".speaker").removeClass("selected c0 c1 c2 c3 c4 c5 c6 c7"),i==n)this.line.speaker_id=0;else{var r=_.pluck(this.speakers,"id").indexOf(i);this.line.speaker_id=i,e.addClass("selected").attr("aria-checked","true"),this.$(".speaker").addClass("selected c"+r)}var s={transcript_id:this.data.transcript_id,transcript_line_id:this.line.id,speaker_id:this.line.speaker_id};$.post(API_URL+"/transcript_speaker_edits.json",{transcript_speaker_edit:s},function(t){})},star:function(t){t.preventDefault(),$(t.currentTarget).toggleClass("active")},verify:function(t){t&&t.preventDefault(),this.select();var e=this;return this.edits.length?void PubSub.publish("transcript.edits.load",{edits:this.edits,line:this.line}):(this.loadEdits(function(){e.verify()}),!1)}}),app.views.TranscriptUserProgress=app.views.Base.extend({template:_.template(TEMPLATES["transcript_user_progress.ejs"]),el:"#transcript-user-progress",events:{"click .progress-toggle":"toggle"},initialize:function(t){this.data={},this.lines=_.map(t.lines,function(t,e){return{index:e,id:t.id,sequence:t.sequence,edited:t.user_text.length>0}}),this.calculate(),this.render(),this.loadListeners()},calculate:function(){var t=this.lines.length,e=_.reduce(this.lines,function(t,e){var i=e.edited?1:0;return t+i},0);this.data.lines_edited=e,this.data.percent_edited=0,this.data.lines_available=0,t>0&&(this.data.percent_edited=UTIL.round(e/t*100,1),this.data.lines_available=t)},loadListeners:function(){var t=this;PubSub.subscribe("transcript.edit.submit",function(e,i){t.onLineEdit(i.transcript_line_id)})},onLineEdit:function(t){if(!(this.data.lines_available<=0)){var e=_.find(this.lines,function(e){return e.id==t});e&&!e.edited&&(this.lines[e.index].edited=!0,this.calculate(),this.render()),this.data.percent_edited>=1&&PubSub.publish("transcript.finished",!0)}},render:function(){this.data.lines_edited>0&&this.$el.addClass("active"),this.$(".progress-content").html(this.template(this.data))},toggle:function(t){t.preventDefault(),this.$el.toggleClass("minimized")}}),app.views.TranscriptToolbar=app.views.Base.extend({template:_.template(TEMPLATES["transcript_toolbar.ejs"]),initialize:function(t){this.data=_.extend({},t),this.loadControls(),this.loadListeners(),this.loadMenu(),this.render()},loadControls:function(){var t=this.data.controls||this.data.project.controls;this.data.controls=_.map(t,_.clone),this.data.controls=_.map(this.data.controls,function(t){var e=t.key;return e.indexOf("[")>=0&&e.indexOf("]")>=0?t.key=t.key.replace(/\[/g,'<span title="'+t.keyLabel+'">').replace(/\]/g,"</span>"):t.key='<span title="'+t.keyLabel+'">'+t.key+"</span>",t}),this.data.control_width_percent=1/this.data.controls.length*100},loadListeners:function(){var t=this;PubSub.subscribe("player.state.change",function(e,i){t.$el.attr("state",i)})},loadMenu:function(){var t=this.data.menu,e=this.data.project.menus;if(this.data.menu="",t&&e[t]&&e[t].length){var i=_.extend({},this.data,{tagName:"div",menu_key:"transcript_edit"}),n=new app.views.Menu(i);this.data.menu=n.toString()}},render:function(){this.$el.html(this.template(this.data))}}),app.views.TranscriptLineVerify=app.views.Base.extend({id:"transcript-line-verify",className:"modal-wrapper",template:_.template(TEMPLATES["transcript_line_verify.ejs"]),events:{"click .option":"select","click .submit":"submit","click .none-correct":"noneCorrect","click .toggle-play":"togglePlay"},initialize:function(t){var e=this;this.data=_.extend({},t),this.data.title=this.data.title||"Choose the best transcription",this.data.active=this.data.active||!1,PubSub.subscribe("transcript.edits.load",function(t,i){e.data.line=i.line,e.showEdits(i.edits)})},noneCorrect:function(t){t.preventDefault();var e=this,i=this.data.line;PubSub.publish("transcript.edit.delete",i),this.$el.find(".option").removeClass("active"),this.data.edits=_.map(this.data.edits,function(t){return t.active=!1,t}),setTimeout(function(){e.submit()},800)},render:function(){this.$el.html(this.template(this.data))},select:function(t){t.preventDefault();var e=this.data.line,i=this.$el.find(".option"),n=$(t.currentTarget),r=parseInt(n.attr("edit-id"));i.not('[edit-id="'+r+'"]').removeClass("active").attr("aria-checked","false"),n.toggleClass("active"),this.data.edits=_.map(this.data.edits,function(t){return t.active=!1,t.id==r&&n.hasClass("active")&&(t.active=!0),t}),n.hasClass("active")?(n.attr("aria-checked","true"),PubSub.publish("transcript.line.verify",{line:e,text:n.text()})):PubSub.publish("transcript.edit.delete",e)},showEdits:function(t){this.data.edits=t,this.render(),PubSub.publish("transcript.play_all",!1),PubSub.publish("modal.invoke",this.id)},submit:function(t){t&&t.preventDefault(),PubSub.publish("transcript.line.submit",!0)},togglePlay:function(t){t&&t.preventDefault(),PubSub.publish("player.toggle-play",!0)}}),app.views.TranscriptEdit=app.views.Transcript.extend({template:_.template(TEMPLATES["transcript_edit.ejs"]),events:{"click #conventions-link":"showConventions"},initialize:function(t){this.data=t,this.loadTranscript(),this.listenForAuth()},finished:function(){this.$(".transcript-finished").addClass("disabled"),this.$(".show-when-finished").addClass("active"),$(window).trigger("scroll-to",[$("#completion-content"),100])},showConventions:function(){this.$(".conventions-page").toggleClass("active")},lineEditDelete:function(t){if(t<0)return!1;var e=$('.line[sequence="'+t+'"] .text-input').first();if(!e.length)return!1;var i=this.data.transcript.lines[t];e.val(i.display_text),e.attr("user-value",""),e.closest(".line").removeClass("user-edited"),this.submitEdit({transcript_id:this.data.transcript.id,transcript_line_id:i.id,text:"",is_deleted:1,is_new:!1})},lineSave:function(t){if(t<0)return!1;var e=$('.line[sequence="'+t+'"] .text-input').first();if(!e.length)return!1;var i=this.data.transcript.lines[t],n=e.val(),r=e.attr("user-value");if(n!=r&&i.is_editable){if($(window).width()<768||this.play_all&&i.display_text==n)return;var s=!e.closest(".line").hasClass("user-edited");e.attr("user-value",n),e.closest(".line").addClass("user-edited"),this.submitEdit({transcript_id:this.data.transcript.id,transcript_line_id:i.id,text:n,is_deleted:0,is_new:s})}},lineVerify:function(t){var e=t.line,i=t.text,n=$('.line[sequence="'+e.sequence+'"] .text-input').first();if(!n.length)return!1;var r=!n.closest(".line").hasClass("user-edited");n.val(i),n.attr("user-value",i),n.closest(".line").addClass("user-edited"),this.submitEdit({transcript_id:this.data.transcript.id,transcript_line_id:e.id,text:i,is_deleted:0,is_new:r})},loadAnalytics:function(){this.$el.on("click",".conventions-link",function(){ANALYTICS.event("transcript","invoke-conventions")}),this.$el.on("click",".tutorial-link",function(){ANALYTICS.event("transcript","invoke-tutorial")})},loadCompletionContent:function(){if(this.data.completion_content="",this.data.project.pages["transcript_finished.md"]){var t=new app.views.Page(_.extend({},{project:this.data.project,page_key:"transcript_finished.md"}));this.data.completion_content=t.toString()}},loadConventions:function(){this.data.page_conventions=this.data.transcript.conventions},loadListeners:function(){var t=this,e=this.data.project.controls;PubSub.subscribe("transcript.play_all",function(e,i){t.play_all=i,console.log("Set play all to",t.play_all)}),$(".control").on("click.transcript",function(i){i.preventDefault();var n=$(this);_.each(e,function(e){n.hasClass(e.id)&&t[e.action]()})}),$(window).on("keydown.transcript",function(i){_.each(e,function(e){var n=[e.keyCode];if(e.keyCode.constructor===Array&&(n=e.keyCode),n.indexOf(i.keyCode)>=0&&(e.shift&&i.shiftKey||!e.shift))return i.preventDefault(),t[e.action]&&t[e.action](),!1})}),PubSub.subscribe("transcript.line.select",function(e,i){t.lineSelect(i.sequence)}),PubSub.subscribe("transcript.line.submit",function(e,i){t.lineSubmit()}),PubSub.subscribe("transcript.line.verify",function(e,i){t.lineVerify(i)}),PubSub.subscribe("transcript.edit.delete",function(e,i){t.lineEditDelete(i.sequence)}),PubSub.subscribe("transcript.finished",function(e){t.onTranscriptFinished()}),PubSub.subscribe("player.toggle-play",function(e,i){t.lineToggle()}),this.$el.on("click.transcript",".start-play",function(e){e.preventDefault(),t.start()}),this.$el.on("click.transcript",".transcript-finished",function(e){e.preventDefault(),t.finished()}),this.$el.on("click.transcript",".play-all",function(e){e.preventDefault(),t.playAll()}),this.$el.on("click.transcript",".mobile-toggle",function(e){e.preventDefault(),t.mobileToggle()}),this.loadAnalytics()},loadPageContent:function(){if(this.data.page_content="",this.data.project.pages["transcript_edit.md"]){var t=new app.views.Page(_.extend({},{transcript:this.data.transcript,project:this.data.project,page_key:"transcript_edit.md"}));this.data.page_content=t.toString()}},loadTutorial:function(){var t=this.data.project.modals.tutorial_edit;!t||"always"!=t.displayMethod&&$.cookie("tutorial_edit-tutorial")||(PubSub.publish("modal.invoke","tutorial_edit"),$.cookie("tutorial_edit-tutorial",1))},loadUserProgress:function(){var t=_.filter(this.data.transcript.lines,function(t){return t.is_available}),e=new app.views.TranscriptUserProgress({lines:t});this.$("#transcript-user-progress").append(e.$el)},onAudioLoad:function(){this.data.debug&&console.log("Loaded audio files"),this.render(),this.$el.removeClass("loading"),this.$(".start-play, .play-all").removeClass("disabled"),this.loadListeners(),this.message("Loaded transcript"),this.loaded||(this.loaded=!0),this.queue_start&&this.start(),this.queue_start=!1,this.checkForStartTime()},onTranscriptFinished:function(){this.$(".completion-content").addClass("active")},onTranscriptLoad:function(t){this.data.debug&&console.log("Transcript",t.toJSON()),PubSub.publish("transcript.load",{transcript:t.toJSON(),action:"edit",label:t.get("title")}),this.data.transcript=t.toJSON(),this.parseTranscript(),this.loadPageContent(),this.loadCompletionContent(),this.loadConventions(),this.loadAudio()},onTimeUpdate:function(){this.player.playing&&this.playerState("playing"),void 0!==this.pause_at_time&&this.player.currentTime>=this.pause_at_time&&this.playerPause({trigger:"end_of_line"})},selectTextRange:function(t){var e=$(".line.active input").first();if(!e.length)return!1;var i=e[0],n=i.value.replace(/\s{2,}/g," ").trim(),r=n.split(/\ +/),s=0,a=0;if(n.length!=i.value.length){var o=e.getInputSelection().start;e.val(n),e.setInputPosition(o)}var c=e.getInputSelection(),l=n.substring(0,c.start),u=l.split(/\ +/).length-2;c.end>c.start?u++:(t<0&&(u+=2),c.start<=0||" "==n.charAt(c.start-1)?t<0&&u--:(c.start>=n.length-1||" "==n.charAt(c.start))&&t>0&&u++),u+=t,u>=r.length&&(u=0),u<0&&(u=r.length-1),$.each(r,function(t,e){return t==u?(a=s+e.length,!1):void(s+=e.length+1)}),i.setSelectionRange&&i.setSelectionRange(s,a)},wordPrevious:function(){this.selectTextRange(-1)},wordNext:function(){this.selectTextRange(1)}}),app.views.TranscriptsIndex=app.views.Base.extend({template:_.template(TEMPLATES["transcript_index.ejs"]),template_list:_.template(TEMPLATES["transcript_list.ejs"]),template_item:_.template(TEMPLATES["transcript_item.ejs"]),className:"transcripts-wrapper",events:{"click .list-next":"nextPage"},initialize:function(t){this.data=t,this.render(),this.$transcripts=this.$("#transcript-results"),this.$facets=this.$("#transcript-facets"),this.transcripts=[],this.defaultSortName=null,this.defaultSortOrder=null,Amplify.getConfig("homepage.search.sort_options.active_sort")&&(this.sortName=this.defaultSortName=Amplify.getConfig("homepage.search.sort_options.active_sort")),Amplify.getConfig("homepage.search.sort_options.active_order")&&(this.sortOrder=this.defaultSortOrder=Amplify.getConfig("homepage.search.sort_options.active_order")),this.data.queryParams&&this.loadParams(this.data.queryParams),this.loadTranscripts(),this.loadCollections(),this.loadListeners()},addList:function(t){this.transcripts=this.transcripts.concat(t.toJSON()),this.isFaceted()?this.facet():(this.defaultSortName&&(this.transcripts=this.sortTranscripts(this.transcripts,this.defaultSortName,this.defaultSortOrder)),this.addListToUI(this.transcripts,t.hasMorePages(),!0,t.getPage()>1))},addListToUI:function(t,e,i,n){var r=this.template_list({has_more:e}),s=$(r),a=s.first();i?this.$transcripts.append(s):(this.$transcripts.empty(),t.length?this.$transcripts.html(s):this.$transcripts.html("<p>No transcripts found!</p>")),this.$transcripts.removeClass("loading"),_.each(t,function(t){var e=new app.views.TranscriptItem({transcript:t});a.append(e.$el)}),n&&$(window).trigger("scroll-to",[s,110])},facet:function(){this.collection.hasAllPages()?this.facetOnClient():this.facetOnServer()},sortTranscripts:function(t,e,i){var n=_.sortByNat(t,function(i){return"random"==e?Math.floor(Math.random()*t.length):i[e]});return"desc"==i.toLowerCase()&&(n=n.reverse()),n},facetOnClient:function(){var t=this.filters||{},e=this.searchKeyword||"",i=_.map(this.transcripts,_.clone);if(_.each(t,function(t,e){i=_.filter(i,function(i){return!_.has(i,e)||i[e]==t})}),e.length){var n=new Fuse(i,{keys:["title","description"],threshold:.2});i=_.union(_.filter(i,function(t){return t.title.toLowerCase().indexOf(e.toLowerCase())>=0||t.description.toLowerCase().indexOf(e.toLowerCase())>=0}),n.search(e))}this.sortName&&(i=this.sortTranscripts(i,this.sortName,this.sortOrder)),
this.renderTranscripts(i)},facetOnServer:function(){this.facetOnClient()},filterBy:function(t,e){this.filters=this.filters||{},this.filters[t]=e,this.filters=_.omit(this.filters,function(t,e){return"ALL"==t}),this.facet(),this.updateUrlParams()},isFaceted:function(){return this.filters||!!this.sortName&&this.sortName!=this.defaultSortName||!!this.sortOrder&&this.sortOrder!=this.defaultSortOrder||this.searchKeyword},loadCollections:function(){var t=this;this.collections=this.collections||this.data.collections,this.collections.fetch({success:function(e,i,n){t.renderFacets(e.toJSON())},error:function(e,i,n){t.renderFacets([])}})},loadListeners:function(){var t=this;PubSub.subscribe("transcripts.filter",function(e,i){t.filterBy(i.name,i.value)}),PubSub.subscribe("transcripts.sort",function(e,i){t.sortBy(i.name,i.order)}),PubSub.subscribe("transcripts.search",function(e,i){t.search(i)})},loadParams:function(t){var e=this;this.filters=this.filters||{},_.each(t,function(t,i){"sort_by"==i?e.sortName=t:"order"==i?e.sortOrder=t:"keyword"==i?e.searchKeyword=t:e.filters[i]=t})},loadTranscripts:function(){var t=this;this.$transcripts.addClass("loading"),this.collection.fetch({success:function(e,i,n){t.addList(e)},error:function(t,e,i){$(window).trigger("alert",["Whoops! We seem to have trouble loading our transcripts. Please try again by refreshing your browser or come back later!"])}})},nextPage:function(t){t.preventDefault(),$(t.currentTarget).remove(),this.collection.nextPage(),this.loadTranscripts()},render:function(){return this.$el.attr("role","main"),this.$el.html(this.template(this.data)),this},renderFacets:function(t){this.facetsView=this.facetsView||new app.views.TranscriptFacets({collections:t,queryParams:this.data.queryParams}),this.$facets.html(this.facetsView.render().$el)},renderTranscripts:function(t){this.addListToUI(t,!1,!1,!0)},search:function(t){this.searchKeyword=t,this.facet()},sortBy:function(t,e){this.sortName=t,this.sortOrder=e,this.facet(),this.updateUrlParams()},updateUrlParams:function(){var t={};if(this.sortName&&this.sortOrder&&(t.sort_by=this.sortName,t.order=this.sortOrder),this.filters&&_.each(this.filters,function(e,i){t[i]=e}),_.keys(t).length>0&&window.history){var e="/"+this.data.route.route+"?"+$.param(t);window.history.pushState(t,document.title,e)}else if(window.history){var e="/"+this.data.route.route;window.history.pushState(t,document.title,e)}}});